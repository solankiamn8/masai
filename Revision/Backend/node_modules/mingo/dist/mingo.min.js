var mingo=(()=>{var Xr=Object.defineProperty;var ro=Object.getOwnPropertyDescriptor;var eo=Object.getOwnPropertyNames;var no=Object.prototype.hasOwnProperty;var lt=(r,t)=>{for(var n in t)Xr(r,n,{get:t[n],enumerable:!0})},oo=(r,t,n,e)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of eo(t))!no.call(r,o)&&o!==n&&Xr(r,o,{get:()=>t[o],enumerable:!(e=ro(t,o))||e.enumerable});return r};var so=r=>oo(Xr({},"__esModule",{value:!0}),r);var ca={};lt(ca,{Aggregator:()=>Gr,Context:()=>tt,ProcessingMode:()=>Nt,Query:()=>Hr,aggregate:()=>ma,createUpdater:()=>Zn,find:()=>ua,update:()=>aa});var Dt=class extends Error{},Gt=Symbol("missing"),Ze="mingo: cycle detected while processing object/array",Jt=r=>{let t=vt(r),n=0,e=t.length;for(;e;)n=(n<<5)-n^t.charCodeAt(--e);return n>>>0},ht=r=>typeof r!="object"&&typeof r!="function"||r===null,tn=r=>ht(r)||S(r)||H(r),rn={undefined:1,null:2,number:3,string:4,symbol:5,object:6,array:7,arraybuffer:8,boolean:9,date:10,regexp:11,function:12};function w(r,t){r===Gt&&(r=void 0),t===Gt&&(t=void 0);let n=100,[e,o]=[r,t].map(s=>rn[nn(s)?"arraybuffer":q(s)]??n);return e!==o?e-o:(e===n&&(r=vt(r),t=vt(t)),B(r,t)?0:r<t?-1:1)}var z=class r extends Map{#t=Jt;#r=new Map;#e=t=>{let n=this.#t(t);return[(this.#r.get(n)||[]).find(e=>B(e,t)),n]};constructor(){super()}static init(t){let n=new r;return t&&(n.#t=t),n}clear(){super.clear(),this.#r.clear()}delete(t){if(ht(t))return super.delete(t);let[n,e]=this.#e(t);return super.delete(n)?(this.#r.set(e,this.#r.get(e).filter(o=>!B(o,n))),!0):!1}get(t){if(ht(t))return super.get(t);let[n,e]=this.#e(t);return super.get(n)}has(t){if(ht(t))return super.has(t);let[n,e]=this.#e(t);return super.has(n)}set(t,n){if(ht(t))return super.set(t,n);let[e,o]=this.#e(t);if(super.has(e))super.set(e,n);else{super.set(t,n);let s=this.#r.get(o)||[];s.push(t),this.#r.set(o,s)}return this}get size(){return super.size}};function m(r,t){if(!r)throw new Dt(t)}function q(r){if(r===null)return"null";let t=typeof r;if(t!=="object"&&t in rn)return t;if(y(r))return"array";if(S(r))return"date";if(H(r))return"regexp";let n=Object.prototype.toString.call(r);return n==="[object Object]"?r?.constructor?.name?.toLowerCase()??"object":n.substring(8,n.length-1).toLowerCase()}var ft=r=>typeof r=="boolean",h=r=>typeof r=="string",io=r=>typeof r=="symbol",b=r=>!isNaN(r)&&typeof r=="number",y=Array.isArray,j=r=>q(r)==="object",en=r=>!ht(r),S=r=>r instanceof Date,H=r=>r instanceof RegExp,Xt=r=>typeof r=="function",l=r=>r==null,Q=(r,t=!0)=>!!r||t&&r==="",Y=r=>l(r)||h(r)&&!r||y(r)&&r.length===0||j(r)&&Object.keys(r).length===0,et=r=>y(r)?r:[r],M=(r,t)=>!!r&&Object.prototype.hasOwnProperty.call(r,t),nn=r=>typeof ArrayBuffer<"u"&&ArrayBuffer.isView(r),G=(r,t)=>{if(l(r)||ft(r)||b(r)||h(r))return r;if(S(r))return new Date(r);if(H(r))return new RegExp(r);if(nn(r)){let n=r.constructor;return new n(r)}if(t instanceof Set||(t=new Set),t.has(r))throw new Error(Ze);t.add(r);try{if(y(r)){let n=new Array(r.length);for(let e=0;e<r.length;e++)n[e]=G(r[e],t);return n}if(j(r)){let n={};for(let e of Object.keys(r))n[e]=G(r[e],t);return n}}finally{t.delete(r)}return r},Je=r=>r===Gt;function yr(r,t){if(Je(r)||l(r))return t;if(Je(t)||l(t))return r;if(ht(r)||ht(t))return t;y(r)&&y(t)&&m(r.length===t.length,"arrays must be of equal length to merge.");for(let n of Object.keys(t))r[n]=yr(r[n],t[n]);return r}function Mt(r,t=Jt){let n=[z.init(t),z.init(t)];if(r.length===0)return[];if(r.some(e=>e.length===0))return[];if(r.length===1)return[...r];r[r.length-1].forEach(e=>n[0].set(e,!0));for(let e=r.length-2;e>-1;e--){if(r[e].forEach(o=>{n[0].has(o)&&n[1].set(o,!0)}),n[1].size===0)return[];n.reverse(),n[1].clear()}return Array.from(n[0].keys())}function nt(r,t=1){let n=new Array;function e(o,s){for(let i=0,p=o.length;i<p;i++)y(o[i])&&(s>0||s<0)?e(o[i],Math.max(-1,s-1)):n.push(o[i])}return e(r,t),n}function po(r){let t={};for(;r;){for(let n of Object.getOwnPropertyNames(r))n in t||(t[n]=r[n]);r=Object.getPrototypeOf(r)}return t}var on=r=>r!=null&&r.toString!==Object.prototype.toString;function B(r,t){if(r===t||Object.is(r,t))return!0;if(r===null||t===null||typeof r!=typeof t||typeof r!="object")return!1;if(S(r))return S(t)&&+r==+t;if(H(r))return H(t)&&r.toString()===t.toString();let n=q(r);if(n!==q(t))return!1;switch(n){case"array":if(r.length!==t.length)return!1;for(let e=0,o=r.length;e<o;e++)if(!B(r[e],t[e]))return!1;return!0;case"object":{let e=Object.keys(r),o=Object.keys(t);if(e.length!==o.length)return!1;for(let s of e)if(!(s in t&&B(r[s],t[s])))return!1;return!0}default:return on(r)&&r.toString()===t.toString()}}function Pt(r,t=Jt){let n=z.init(t);return r.forEach(e=>n.set(e,!0)),Array.from(n.keys())}function vt(r,t){if(r===null)return"null";if(r===void 0)return"undefined";if(h(r)||b(r)||ft(r))return JSON.stringify(r);if(S(r))return r.toISOString();if(H(r)||io(r)||Xt(r))return r.toString();if(t instanceof Set||(t=new Set),t.has(r))throw new Error(Ze);try{if(t.add(r),y(r))return"["+r.map(e=>vt(e,t)).join(",")+"]";if(j(r))return"{"+Object.keys(r).sort().map(o=>`${o}:${vt(r[o],t)}`).join()+"}";let n=on(r)?r.toString():vt(po(r),t);return q(r)+"("+n+")"}finally{t.delete(r)}}function Zt(r,t){return l(r)?null:(t=t||Jt,t(r))}function Rt(r,t,n=Jt){if(r.length<1)return new Map;let e=z.init(n);for(let o=0;o<r.length;o++){let s=r[o],i=t(s,o)??null,p=e.get(i);p?p.push(s):(p=[s],e.set(i,p))}return e}function Zr(r,t){return en(r)?r[t]:void 0}function ao(r,t){if(t<1)return r;for(;t--&&r.length===1;)r=r[0];return r}function k(r,t,n){let e=0;function o(i,p){let a=i;for(let c=0;c<p.length;c++){let f=p[c];if(/^\d+$/.exec(f)===null&&y(a)){if(c===0&&e>0)break;e+=1;let A=p.slice(c);a=a.reduce((d,x)=>{let g=o(x,A);return g!==void 0&&d.push(g),d},[]);break}else a=Zr(a,f);if(a===void 0)break}return a}let s=tn(r)?r:o(r,t.split("."));return y(s)&&n?.unwrapArray?ao(s,e):s}function bt(r,t,n){let e=t.indexOf("."),o=e==-1?t:t.substring(0,e),s=t.substring(e+1),i=e!=-1;if(y(r)){let c=/^\d+$/.test(o),f=c&&n?.preserveIndex?[...r]:[];if(c){let O=parseInt(o),A=Zr(r,O);i&&(A=bt(A,s,n)),n?.preserveIndex?f[O]=A:f.push(A)}else for(let O of r){let A=bt(O,t,n);n?.preserveMissing?f.push(A??Gt):(A!=null||n?.preserveIndex)&&f.push(A)}return f}let p=n?.preserveKeys?{...r}:{},a=Zr(r,o);if(i&&(a=bt(a,s,n)),a!==void 0)return p[o]=a,p}function fr(r){if(y(r))for(let t=r.length-1;t>=0;t--)r[t]===Gt?r.splice(t,1):fr(r[t]);else if(j(r))for(let t in r)M(r,t)&&fr(r[t])}var Xe=/^\d+$/;function _t(r,t,n,e){let o=t.split("."),s=o[0],i=o.slice(1).join(".");if(o.length===1)(j(r)||y(r)&&Xe.test(s))&&n(r,s);else{e?.buildGraph&&l(r[s])&&(r[s]={});let p=r[s];if(!p)return;let a=!!(o.length>1&&Xe.test(o[1]));y(p)&&e?.descendArray&&!a?p.forEach((c=>_t(c,i,n,e))):_t(p,i,n,e)}}function jt(r,t,n){_t(r,t,((e,o)=>{e[o]=Xt(n)?n(e[o]):n}),{buildGraph:!0})}function Tt(r,t,n){_t(r,t,((e,o)=>{y(e)?e.splice(parseInt(o),1):j(e)&&delete e[o]}),n)}var J=r=>r&&r[0]==="$"&&/^\$[a-zA-Z0-9_]+$/.test(r);function Or(r){if(tn(r))return H(r)?{$regex:r}:{$eq:r};if(en(r)){if(!Object.keys(r).some(J))return{$eq:r};if(M(r,"$regex")){let t={...r};return t.$regex=new RegExp(r.$regex,r.$options),delete t.$options,t}}return r}function Ut(r,t,n=w){let e=0,o=r.length-1;for(;e<=o;){let s=Math.round(e+(o-e)/2);if(n(t,r[s])<0)o=s-1;else if(n(t,r[s])>0)e=s+1;else return s}return e}var Nt=(o=>(o[o.CLONE_OFF=0]="CLONE_OFF",o[o.CLONE_INPUT=1]="CLONE_INPUT",o[o.CLONE_OUTPUT=2]="CLONE_OUTPUT",o[o.CLONE_ALL=3]="CLONE_ALL",o))(Nt||{}),I=class r{#t;#r;#e;constructor(t,n,e){this.#t=t,this.update(n,e)}static init(t,n,e){return t instanceof r?new r(t.#t,t.root??n,{...t.#e,...e,variables:Object.assign({},t.#e?.variables,e?.variables)}):new r(t,n,e)}update(t,n){this.#r=t;let e=Object.assign({},this.#e?.variables,n?.variables);return Object.keys(e).length?this.#e={...n,variables:e}:this.#e=n??{},this}getOptions(){return Object.freeze({...this.#t,context:tt.from(this.#t.context)})}get root(){return this.#r}get local(){return this.#e}get idKey(){return this.#t.idKey}get collation(){return this.#t?.collation}get processingMode(){return this.#t?.processingMode||0}get useStrictMode(){return this.#t?.useStrictMode}get scriptEnabled(){return this.#t?.scriptEnabled}get useGlobalContext(){return this.#t?.useGlobalContext}get hashFunction(){return this.#t?.hashFunction}get collectionResolver(){return this.#t?.collectionResolver}get jsonSchemaValidator(){return this.#t?.jsonSchemaValidator}get variables(){return this.#t?.variables}get context(){return this.#t?.context}};function yt(r){return r instanceof I?r.getOptions():Object.freeze({idKey:"_id",scriptEnabled:!0,useStrictMode:!0,useGlobalContext:!0,processingMode:0,...r,context:tt.from(r?.context??tt.init())})}var wt=(i=>(i.ACCUMULATOR="accumulator",i.EXPRESSION="expression",i.PIPELINE="pipeline",i.PROJECTION="projection",i.QUERY="query",i.WINDOW="window",i))(wt||{}),tt=class r{#t=new Map(Object.values(wt).map(t=>[t,{}]));constructor(){}static init(t={}){let n=new r;for(let[e,o]of Object.entries(t))n.#t.has(e)&&o&&n.addOperators(e,o);return n}static from(t){return r.init(t&&Object.fromEntries(t.#t)||{})}static merge(t,n){let e=r.from(t);for(let o of Object.values(wt))e.addOperators(o,n.#t.get(o));return e}addOperators(t,n){return this.#t.set(t,Object.assign({},n,this.#t.get(t))),this}getOperator(t,n){return this.#t.get(t)[n]??null}addAccumulatorOps(t){return this.addOperators("accumulator",t)}addExpressionOps(t){return this.addOperators("expression",t)}addQueryOps(t){return this.addOperators("query",t)}addPipelineOps(t){return this.addOperators("pipeline",t)}addProjectionOps(t){return this.addOperators("projection",t)}addWindowOps(t){return this.addOperators("window",t)}},ot=tt.init(),Oa={accumulator:ot.addAccumulatorOps.bind(ot),expression:ot.addExpressionOps.bind(ot),pipeline:ot.addPipelineOps.bind(ot),projection:ot.addProjectionOps.bind(ot),query:ot.addQueryOps.bind(ot),window:ot.addWindowOps.bind(ot)};function st(r,t,n){if(!J(t))return null;let{context:e,useGlobalContext:o}=n||{},s=e?e.getOperator(r,t):null;return!s&&o?ot.getOperator(r,t):s}function u(r,t,n,e){let o=I.init(e,r);return n&&J(n)?sn(r,t,n,o):Ar(r,t,o)}var mo=["$$ROOT","$$CURRENT","$$REMOVE","$$NOW"];function Ar(r,t,n){if(h(t)&&t.length>0&&t[0]==="$"){if(uo.includes(t))return t;let e=n.root,o=t.split(".");if(mo.includes(o[0])){switch(o[0]){case"$$ROOT":break;case"$$CURRENT":e=r;break;case"$$REMOVE":e=void 0;break;case"$$NOW":e=new Date;break}t=t.slice(o[0].length+1)}else if(o[0].slice(0,2)==="$$"){e=Object.assign({},n.variables,{this:r},n?.local?.variables);let s=o[0].slice(2);m(M(e,s),`Use of undefined variable: ${s}`),t=t.slice(2)}else t=t.slice(1);return t===""?e:k(e,t)}if(y(t))return t.map(e=>Ar(r,e,n));if(j(t)){let e={},o=Object.entries(t);for(let[s,i]of o){if(J(s))return m(o.length==1,"expression must have single operator."),sn(r,i,s,n);e[s]=Ar(r,i,n)}return e}return t}function sn(r,t,n,e){let o=st("expression",n,e);if(o)return o(r,t,e);let s=st("accumulator",n,e);return m(!!s,`accumulator '${n}' is not registered.`),y(r)||(r=Ar(r,t,e),t=null),m(y(r),`arguments must resolve to array for ${n}.`),s(r,t,e)}var uo=["$$KEEP","$$PRUNE","$$DESCEND"];function br(r,t,n){let e=u(r,t,null,n);switch(e){case"$$KEEP":return r;case"$$PRUNE":return;case"$$DESCEND":{if(!M(t,"$cond"))return r;let o={};for(let[s,i]of Object.entries(r))if(y(i)){let p=new Array;for(let a of i)j(a)&&(a=br(a,t,n.update(a))),l(a)||p.push(a);o[s]=p}else if(j(i)){let p=br(i,t,n.update(i));l(p)||(o[s]=p)}else o[s]=i;return o}default:return e}}function N(r){return r instanceof Ft?r:new Ft(r)}function dt(...r){let t=0;return N(()=>{for(;t<r.length;){let n=r[t].next();if(!n.done)return n;t++}return{done:!0}})}function co(r){return!!r&&typeof r=="object"&&typeof r?.next=="function"}function lo(r){return!!r&&(typeof r=="object"||typeof r=="function")&&typeof r[Symbol.iterator]=="function"}var Ft=class{#t=[];#r=[];#e;#o=!1;constructor(t){let n=lo(t)?t[Symbol.iterator]():co(t)?t:typeof t=="function"?{next:t}:null;m(!!n,"Iterator must be initialized with an iterable or function.");let e=-1,o={done:!1};this.#e=()=>{for(;!o.done&&(o=n.next(),!o.done);){let s=o.value;if(e++,this.#t.every(({op:p,fn:a})=>{let c=a(s,e);return p==="map"?!!(s=c)||!0:c}))return{value:s,done:!1}}return{done:!0}}}push(t,n){return this.#t.push({op:t,fn:n}),this}next(){return this.#e()}map(t){return this.push("map",t)}filter(t){return this.push("filter",t)}take(t){return t>0?this.filter(n=>!(t===0||t--===0)):this}drop(t){return t>0?this.filter(n=>t===0||t--===0):this}transform(t){let n=this,e;return N(()=>(e||(e=N(t(n.value()))),e.next()))}value(){for(;!this.#o;){let{done:t,value:n}=this.#e();t||this.#r.push(n),this.#o=t}return this.#r}each(t){for(;;){let n=this.next();if(n.done)break;if(t(n.value)===!1)return!1}return!0}reduce(t,n){let e=this.next();for(n===void 0&&!e.done&&(n=e.value,e=this.next());!e.done;)n=t(n,e.value),e=this.next();return n}size(){return this.reduce(((t,n)=>++t),0)}[Symbol.iterator](){return this}};var pt=class{#t;#r;constructor(t,n){this.#t=t,this.#r=n}stream(t,n){let e=N(t),o=n??this.#r,s=o.processingMode;return s&1&&e.map(G),e=this.#t.map((i,p)=>{let a=Object.keys(i);m(a.length===1,`aggregation stage must have single operator, got ${a.toString()}.`);let c=a[0];m(c!=="$documents"||p==0,"$documents must be first stage in pipeline.");let f=st("pipeline",c,o);return m(!!f,`unregistered pipeline operator ${c}.`),[f,i[c]]}).reduce((i,[p,a])=>p(i,a,o),e),s&2&&e.map(G),e}run(t,n){return this.stream(t,n).value()}};var ie={};lt(ie,{$accumulator:()=>fo,$addToSet:()=>yo,$avg:()=>Oo,$bottom:()=>xo,$bottomN:()=>te,$count:()=>go,$covariancePop:()=>ho,$covarianceSamp:()=>jo,$first:()=>re,$firstN:()=>gr,$last:()=>ee,$lastN:()=>hr,$max:()=>Eo,$maxN:()=>jr,$median:()=>ne,$mergeObjects:()=>oe,$min:()=>$o,$minN:()=>Er,$percentile:()=>tr,$push:()=>$,$stdDevPop:()=>Io,$stdDevSamp:()=>To,$sum:()=>wo,$top:()=>No,$topN:()=>se});var fo=(r,t,n)=>{if(m(!!n&&n.scriptEnabled,"$accumulator operator requires 'scriptEnabled' option to be true"),r.length==0)return t.initArgs;let e=I.init(n),o=u({},t.initArgs||[],null,e.update(e?.local?.groupId||{})),s=t.init.call(null,...o);for(let i of r){let p=u(i,t.accumulateArgs,null,e.update(i));s=t.accumulate.call(null,s,...p)}return t.finalize?t.finalize.call(null,s):s};var $=(r,t,n)=>{if(l(t))return r;let e=I.init(n);return r.map(o=>u(o,t,null,e.update(o)))};var yo=(r,t,n)=>Pt($(r,t,n),n?.hashFunction);var Oo=(r,t,n)=>{let e=$(r,t,n).filter(b);return e.reduce((s,i)=>s+i,0)/(e.length||1)};var Z=(r,t,n)=>{if(Y(t)||!j(t))return r;let e=w,o=n.collation;return j(o)&&h(o.locale)&&(e=bo(o)),r.transform(s=>{let i=Object.keys(t);for(let p of i.reverse()){let a=Rt(s,O=>k(O,p),n.hashFunction),c=Array.from(a.keys()).sort(e);t[p]===-1&&c.reverse();let f=0;for(let O of c)for(let A of a.get(O))s[f++]=A;m(f==s.length,"bug: counter must match collection size.")}return s})},Ao={1:"base",2:"accent",3:"variant"};function bo(r){let t={sensitivity:Ao[r.strength||3],caseFirst:r.caseFirst==="off"?"false":r.caseFirst||"false",numeric:r.numericOrdering||!1,ignorePunctuation:r.alternate==="shifted"};r.caseLevel===!0&&(t.sensitivity==="base"&&(t.sensitivity="case"),t.sensitivity==="accent"&&(t.sensitivity="variant"));let n=new Intl.Collator(r.locale,t);return(e,o)=>{if(!h(e)||!h(o))return w(e,o);let s=n.compare(e,o);return s<0?-1:s>0?1:0}}var te=(r,t,n)=>{let e=I.init(n),o=u(e.local.groupId,t.n,null,e),s=Z(N(r),t.sortBy,n).value(),i=s.length;return $(i<=o?s:s.slice(i-o),t.output,e)};var xo=(r,t,n)=>te(r,{...t,n:1},n);var go=(r,t,n)=>r.length;function dr(r,t=!0){let n=r.reduce((s,i)=>s+i,0),e=r.length||1,o=n/e;return Math.sqrt(r.reduce((s,i)=>s+Math.pow(i-o,2),0)/(e-Number(t)))}function xr(r,t=!0){if(!r)return null;if(r.length<2)return t?null:0;let n=0,e=0;for(let[s,i]of r)n+=s,e+=i;n/=r.length,e/=r.length;let o=0;for(let[s,i]of r)o+=(s-n)*(i-e);return o/(r.length-Number(t))}var ho=(r,t,n)=>xr($(r,t,n),!1);var jo=(r,t,n)=>xr($(r,t,n),!0);var re=(r,t,n)=>{if(r.length===0)return;let e=I.init(n).update(r[0]);return u(r[0],t,null,e)};var gr=(r,t,n)=>{let e=I.init(n),o=r.length,s=u(e?.local?.groupId,t.n,null,e);return m(s>0,"$firstN: 'n' must resolve to a positive integer."),$(o<=s?r:r.slice(0,s),t.input,n)};var ee=(r,t,n)=>{if(r.length===0)return;let e=r[r.length-1],o=I.init(n).update(e);return u(e,t,null,o)};var hr=(r,t,n)=>{let e=I.init(n),o=r.length,s=u(e?.local?.groupId,t.n,null,e);return $(o<=s?r:r.slice(o-s),t.input,n)};var Eo=(r,t,n)=>{let e=$(r,t,n);if(Y(e))return null;m(y(e),"$max: input must resolve to array");let o=e[0];for(let s of e)l(s)||isNaN(s)||w(s,o)>=0&&(o=s);return o};var jr=(r,t,n)=>{let e=I.init(n),o=r.length,s=u(e?.local?.groupId,t.n,null,e),i=$(r,t.input,n).filter(p=>!l(p));return i.sort((p,a)=>-1*w(p,a)),o<=s?i:i.slice(0,s)};var tr=(r,t,n)=>{let e=$(r,t.input,n).filter(b).sort(),o=$(t.p,"$$CURRENT",n).filter(b),s=t.method||"approximate";return o.map(i=>{m(i>0&&i<=1,`percentile value must be between 0 (exclusive) and 1 (inclusive): invalid '${i}'.`);let p=i*(e.length-1)+1,a=Math.floor(p),c=p===a?e[p-1]:e[a-1]+p%1*(e[a]-e[a-1]||0);switch(s){case"exact":return c;case"approximate":{let f=Ut(e,c);return f/e.length>=i?e[Math.max(f-1,0)]:e[f]}}})};var ne=(r,t,n)=>tr(r,{...t,p:[.5]},n).pop();var oe=(r,t,n)=>{let e={};for(let o of r)if(!l(o))for(let s of Object.keys(o))o[s]!==void 0&&(e[s]=o[s]);return e};var $o=(r,t,n)=>{let e=$(r,t,n);if(Y(e))return null;m(y(e),"$min: input must resolve to array");let o=e[0];for(let s of e)l(s)||isNaN(s)||w(s,o)<=0&&(o=s);return o};var Er=(r,t,n)=>{let e=I.init(n),o=r.length,s=u(e?.local?.groupId,t.n,null,e),i=$(r,t.input,n).filter(p=>!l(p));return i.sort(w),o<=s?i:i.slice(0,s)};var Io=(r,t,n)=>dr($(r,t,n).filter(b),!1);var To=(r,t,n)=>dr($(r,t,n).filter(b),!0);var wo=(r,t,n)=>y(r)?b(t)?r.length*t:$(r,t,n).filter(b).reduce((o,s)=>o+s,0):0;var se=(r,t,n)=>{let e=I.init(n),{n:o,sortBy:s}=u(e.local.groupId,t,null,e),i=Z(N(r),s,n).take(o).value();return $(i,t.output,e)};var No=(r,t,n)=>se(r,{...t,n:1},n);var Pe={};lt(Pe,{$abs:()=>ko,$acos:()=>Ni,$acosh:()=>ki,$add:()=>So,$allElementsTrue:()=>Xs,$and:()=>An,$anyElementTrue:()=>Zs,$arrayElemAt:()=>Qo,$arrayToObject:()=>Ko,$asin:()=>Si,$asinh:()=>Ci,$atan:()=>vi,$atan2:()=>Di,$atanh:()=>_i,$bitAnd:()=>As,$bitNot:()=>bs,$bitOr:()=>ds,$bitXor:()=>xs,$ceil:()=>Co,$cmp:()=>xn,$concat:()=>si,$concatArrays:()=>qo,$cond:()=>gs,$convert:()=>Qi,$cos:()=>Mi,$cosh:()=>Pi,$dateAdd:()=>kt,$dateDiff:()=>Ns,$dateFromParts:()=>Cs,$dateFromString:()=>Ps,$dateSubtract:()=>Rs,$dateToParts:()=>Us,$dateToString:()=>we,$dateTrunc:()=>Bs,$dayOfMonth:()=>Ae,$dayOfWeek:()=>be,$dayOfYear:()=>de,$degreesToRadians:()=>Ui,$divide:()=>vo,$eq:()=>gn,$exp:()=>Do,$filter:()=>Yo,$first:()=>Ho,$firstN:()=>Go,$floor:()=>_o,$function:()=>fe,$getField:()=>Ks,$gt:()=>hn,$gte:()=>jn,$hour:()=>xe,$ifNull:()=>le,$in:()=>Jo,$indexOfArray:()=>Xo,$indexOfBytes:()=>ii,$isArray:()=>Zo,$isNumber:()=>Ki,$isoDayOfWeek:()=>ge,$isoWeek:()=>he,$isoWeekYear:()=>Ls,$last:()=>ts,$lastN:()=>rs,$let:()=>Hi,$literal:()=>zs,$ln:()=>Mo,$log:()=>Po,$log10:()=>Ro,$lt:()=>En,$lte:()=>$n,$ltrim:()=>ai,$map:()=>es,$maxN:()=>ns,$median:()=>Qs,$mergeObjects:()=>Ne,$millisecond:()=>je,$minN:()=>os,$minute:()=>Ee,$mod:()=>Uo,$month:()=>$e,$multiply:()=>Fo,$ne:()=>In,$nin:()=>ms,$not:()=>bn,$objectToArray:()=>Hs,$or:()=>dn,$percentile:()=>Js,$pow:()=>Vo,$radiansToDegrees:()=>Vi,$rand:()=>qs,$range:()=>us,$reduce:()=>cs,$regexFind:()=>mi,$regexFindAll:()=>ui,$regexMatch:()=>ci,$replaceAll:()=>li,$replaceOne:()=>fi,$reverseArray:()=>ls,$round:()=>Wo,$rtrim:()=>yi,$sampleRate:()=>Ys,$second:()=>Ie,$setDifference:()=>ti,$setEquals:()=>ri,$setField:()=>ke,$setIntersection:()=>ei,$setIsSubset:()=>ni,$setUnion:()=>oi,$sin:()=>Wi,$sinh:()=>Bi,$size:()=>fs,$slice:()=>ce,$sortArray:()=>ys,$split:()=>Oi,$sqrt:()=>Bo,$strLenBytes:()=>bi,$strLenCP:()=>di,$strcasecmp:()=>Ai,$substr:()=>Se,$substrBytes:()=>ji,$substrCP:()=>Ei,$subtract:()=>Lo,$switch:()=>hs,$tan:()=>Li,$tanh:()=>zi,$toBool:()=>Ce,$toDate:()=>ve,$toDecimal:()=>qi,$toDouble:()=>pr,$toHashedIndexKey:()=>wi,$toInt:()=>De,$toLong:()=>_e,$toLower:()=>$i,$toString:()=>Me,$toUpper:()=>Ii,$trim:()=>Ti,$trunc:()=>zo,$type:()=>Yi,$unsetField:()=>Gs,$week:()=>Te,$year:()=>Br,$zip:()=>Os});var ko=(r,t,n)=>{let e=u(r,t,null,n);return l(e)?null:Math.abs(e)};var So=(r,t,n)=>{let e=u(r,t,null,n),o=!1,s=0;for(let i of e)S(i)&&(m(!o,"'$add' can only have one date value"),o=!0),s+=+i;return o?new Date(s):s};var Co=(r,t,n)=>{let e=u(r,t,null,n);return l(e)?null:(m(b(e)||isNaN(e),"$ceil expression must resolve to a number."),Math.ceil(e))};var vo=(r,t,n)=>{let e=u(r,t,null,n);return e[0]/e[1]};var Do=(r,t,n)=>{let e=u(r,t,null,n);return l(e)?null:(m(b(e)||isNaN(e),"$exp expression must resolve to a number."),Math.exp(e))};var _o=(r,t,n)=>{let e=u(r,t,null,n);return l(e)?null:(m(b(e)||isNaN(e),"$floor expression must resolve to a number."),Math.floor(e))};var Mo=(r,t,n)=>{let e=u(r,t,null,n);return l(e)?null:(m(b(e)||isNaN(e),"$ln expression must resolve to a number."),Math.log(e))};var Po=(r,t,n)=>{let e=u(r,t,null,n),o="$log expression must resolve to array(2) of numbers";return m(y(e)&&e.length===2,o),e.some(l)?null:(m(e.some(isNaN)||e.every(b),o),Math.log10(e[0])/Math.log10(e[1]))};var Ro=(r,t,n)=>{let e=u(r,t,null,n);return l(e)?null:(m(b(e)||isNaN(e),"$log10 expression must resolve to a number."),Math.log10(e))};var Uo=(r,t,n)=>{let e=u(r,t,null,n);return e[0]%e[1]};var Fo=(r,t,n)=>u(r,t,null,n).reduce((o,s)=>o*s,1);var Vo=(r,t,n)=>{let e=u(r,t,null,n);return m(y(e)&&e.length===2&&e.every(b),"$pow expression must resolve to array(2) of numbers"),m(!(e[0]===0&&e[1]<0),"$pow cannot raise 0 to a negative exponent"),Math.pow(e[0],e[1])};function $r(r,t=0,n=!1){let e=Math.abs(r)===r?1:-1;r=Math.abs(r);let o=Math.trunc(r),s=parseFloat((r-o).toFixed(Math.abs(t)+1));if(t===0){let i=Math.trunc(10*s);n&&((o&1)===1&&i>=5||i>5)&&o++}else if(t>0){let i=Math.pow(10,t),p=Math.trunc(s*i),a=Math.trunc(s*i*10)%10;n&&a>5&&(p+=1),o=(o*i+p)/i}else if(t<0){let i=Math.pow(10,-1*t),p=o%i;if(o=Math.max(0,o-p),n&&e===-1){for(;p>10;)p-=p/10;o>0&&p>=5&&(o+=i)}}return o*e}var Wo=(r,t,n)=>{let e=u(r,t,null,n),o=e[0],s=e[1];return l(o)||isNaN(o)||Math.abs(o)===1/0?o:(m(b(o),"$round expression must resolve to a number."),$r(o,s,!0))};var Bo=(r,t,n)=>{let e=u(r,t,null,n);return l(e)?null:(m(b(e)&&e>0||isNaN(e),"$sqrt expression must resolve to non-negative number."),Math.sqrt(e))};var Lo=(r,t,n)=>{let e=u(r,t,null,n),o="$subtract: must resolve to array(2) of numbers/dates";m(y(e)&&e.length===2,o);let s=e.map(q).join("|");return s==="date|number"?new Date(+e[0]-+e[1]):(m(s==="date|date"||s==="number|number",o),+e[0]-+e[1])};var zo=(r,t,n)=>{let e=u(r,t,null,n),o=e[0],s=e[1];return l(o)||isNaN(o)||Math.abs(o)===1/0?o:(m(b(o),"$trunc expression must resolve to a number."),m(l(s)||b(s)&&s>-20&&s<100,"$trunc expression has invalid place"),$r(o,s,!1))};var Qo=(r,t,n)=>{let e=u(r,t,null,n);if(m(y(e)&&e.length===2,"$arrayElemAt expression must resolve to array(2)"),e.some(l))return null;let o=e[1],s=e[0];if(o<0&&Math.abs(o)<=s.length)return s[(o+s.length)%s.length];if(o>=0&&o<s.length)return s[o]};var Ko=(r,t,n)=>{let e=u(r,t,null,n);return m(y(e),"$arrayToObject: expression must resolve to an array"),e.reduce((o,s)=>{for(;y(s)&&s.length===1;)s=s[0];if(y(s)&&s.length==2)o[s[0]]=s[1];else{let i=s;m(j(i)&&M(i,"k")&&M(i,"v"),"$arrayToObject expression is invalid."),o[i.k]=i.v}return o},{})};var qo=(r,t,n)=>{let e=u(r,t,null,n);m(y(e),"$concatArrays: input must resolve to an array");let o=0;for(let p of e){if(l(p))return null;o+=p.length}let s=new Array(o),i=0;for(let p of e)for(let a of p)s[i++]=a;return s};var Yo=(r,t,n)=>{let e=u(r,t.input,null,n);if(l(e))return null;m(y(e),"$filter 'input' expression must resolve to an array");let o=I.init(n,r),s=t.as||"this",i={variables:{[s]:null}};return e.filter(p=>{i.variables[s]=p;let a=u(r,t.cond,null,o.update(o.root,i));return Q(a,n.useStrictMode)})};var Ho=(r,t,n)=>{if(y(r))return re(r,t,n);let e=u(r,t,null,n);return l(e)?null:(m(y(e)&&e.length>0,"$first must resolve to a non-empty array."),nt(e)[0])};var Go=(r,t,n)=>{if(y(r))return gr(r,t,n);let{input:e,n:o}=u(r,t,null,n);return l(e)?null:(m(y(e),"$firstN: 'input' must resolve to an array."),gr(e,{n:o,input:"$$this"},n))};var Jo=(r,t,n)=>{let[e,o]=u(r,t,null,n);return m(y(o),"$in second argument must be an array"),o.some(s=>B(s,e))};var Xo=(r,t,n)=>{let e=u(r,t,null,n);if(l(e))return null;let o=e[0],s=e[1];if(l(o))return null;m(y(o),"$indexOfArray expression must resolve to an array.");let i=e[2]||0,p=e[3];if(l(p)&&(p=o.length),i>p)return-1;m(i>=0&&p>=0,"$indexOfArray expression is invalid"),(i>0||p<o.length)&&(o=o.slice(i,p));let a=-1;return o.some((c,f)=>{let O=B(c,s);return O&&(a=f),O}),a+i};var Zo=(r,t,n)=>{let e=y(t);return m(!e||t.length===1,"$isArray takes exactly 1 argument."),y(u(r,e?t[0]:t,null,n))};var ts=(r,t,n)=>{if(y(r))return ee(r,t,n);let e=u(r,t,null,n);return l(e)?null:(m(y(e)&&e.length>0,"$last must resolve to a non-empty array."),nt(e)[e.length-1])};var rs=(r,t,n)=>{if(y(r))return hr(r,t,n);let{input:e,n:o}=u(r,t,null,n);return l(e)?null:(m(y(e),"Must resolve to an array/null or missing"),hr(e,{n:o,input:"$$this"},n))};var es=(r,t,n)=>{let e=u(r,t.input,null,n);if(l(e))return null;m(y(e),"$map 'input' expression must resolve to an array");let o=I.init(n),s=t.as||"this";return e.map(i=>u(r,t.in,null,o.update(o.root,{variables:{[s]:i}})))};var ns=(r,t,n)=>{if(y(r))return jr(r,t,n);let{input:e,n:o}=u(r,t,null,n);return l(e)?null:(m(y(e),"Must resolve to an array/null or missing"),jr(e,{n:o,input:"$$this"},n))};var os=(r,t,n)=>{if(y(r))return Er(r,t,n);let{input:e,n:o}=u(r,t,null,n);return l(e)?null:(m(y(e),"$minN: 'input' must resolve to an array."),Er(e,{n:o,input:"$$this"},n))};var pe=(r,t,n)=>r.take(t);var rr=(r,t,n)=>Y(t)?r:(an(t,n),r.map(pn(t,I.init(n))));function pn(r,t,n=!0){let e=t.idKey,o=Object.keys(r),s=new Array,i=new Array,p={};for(let d of o){let x=r[d];if(b(x)||ft(x))x?i.push(d):s.push(d);else if(y(x))p[d]=g=>x.map(E=>u(g,E,null,t.update(g))??null);else if(j(x)){let g=Object.keys(x),E=g.length==1?g[0]:"",T=st("projection",E,t);T?E==="$slice"&&!et(x[E]).every(b)?p[d]=D=>u(D,x,d,t.update(D)):p[d]=D=>T(D,x[E],d,t.update(D)):J(E)?p[d]=F=>u(F,x[E],E,t):(an(x,t),p[d]=F=>{if(!M(F,d))return u(F,x,null,t);n&&t.update(F);let D=k(F,d),L=pn(x,t,!1);return y(D)?D.map(L):j(D)?L(D):L(F)})}else p[d]=h(x)&&x[0]==="$"?g=>u(g,x,d,t):g=>x}let a=Object.keys(p),c=s.includes(e);if(n&&c&&s.length===1&&!i.length&&!a.length)return d=>{let x={...d};return delete x[e],x};let O=n&&!c&&!i.includes(e),A={preserveMissing:!0};return d=>{let x={};if(s.length&&!i.length){yr(x,d);for(let g of s)Tt(x,g,{descendArray:!0})}for(let g of i){let E=bt(d,g,A)??{};yr(x,E)}i.length&&fr(x);for(let g of a){let E=p[g](d);E===void 0?Tt(x,g,{descendArray:!0}):jt(x,g,E)}return O&&M(d,e)&&(x[e]=k(d,e)),x}}function an(r,t){let n=!1,e=!1;for(let[o,s]of Object.entries(r))m(!o.startsWith("$"),"Field names may not start with '$'."),m(!o.endsWith(".$"),"Positional projection operator '$' is not supported."),o!==t?.idKey&&(s===0||s===!1?n=!0:(s===1||s===!0)&&(e=!0),m(!(n&&e),"Projection cannot have a mix of inclusion and exclusion."))}var ae=(r,t,n)=>r.drop(t);var ss={$sort:Z,$skip:ae,$limit:pe},Ir=class{#t;#r;#e;#o;#i={};#n=null;#s=[];constructor(t,n,e,o){this.#t=t,this.#r=n,this.#e=e,this.#o=o}fetch(){if(this.#n)return this.#n;this.#n=N(this.#t).filter(this.#r);let t=this.#o.processingMode;t&1&&this.#n.map(G);for(let n of["$sort","$skip","$limit"])M(this.#i,n)&&(this.#n=ss[n](this.#n,this.#i[n],this.#o));return Object.keys(this.#e).length&&(this.#n=rr(this.#n,this.#e,this.#o)),t&2&&this.#n.map(G),this.#n}fetchAll(){let t=N([...this.#s]);return this.#s.length=0,dt(t,this.fetch())}all(){return this.fetchAll().value()}count(){return this.all().length}skip(t){return this.#i.$skip=t,this}limit(t){return this.#i.$limit=t,this}sort(t){return this.#i.$sort=t,this}collation(t){return this.#o={...this.#o,collation:t},this}next(){if(this.#s.length>0)return this.#s.pop();let t=this.fetch().next();if(!t.done)return t.value}hasNext(){if(this.#s.length>0)return!0;let t=this.fetch().next();return t.done?!1:(this.#s.push(t.value),!0)}map(t){return this.all().map(t)}forEach(t){this.all().forEach(t)}[Symbol.iterator](){return this.fetchAll()}};var is=/^\$(and|or|nor|expr|jsonSchema)$/,X=class{#t;#r;#e;constructor(t,n){this.#e=G(t),this.#r=n,this.#t=[],this.compile()}compile(){m(j(this.#e),`query criteria must be an object: ${JSON.stringify(this.#e)}`);let t={};for(let[n,e]of Object.entries(this.#e)){if(n==="$where")m(this.#r.scriptEnabled,"$where operator requires 'scriptEnabled' option to be true."),Object.assign(t,{field:n,expr:e});else if(is.test(n))this.processOperator(n,n,e);else{m(!J(n),`unknown top level operator: ${n}`);for(let[o,s]of Object.entries(Or(e)))this.processOperator(n,o,s)}t.field&&this.processOperator(t.field,t.field,t.expr)}}processOperator(t,n,e){let o=st("query",n,this.#r);m(!!o,`unknown query operator ${n}`),this.#t.push(o(t,e,this.#r))}test(t){return this.#t.every(n=>n(t))}find(t,n){return new Ir(t,e=>this.test(e),n||{},this.#r)}};function C(r,t,n,e){let o={unwrapArray:!0},s=Math.max(1,r.split(".").length-1);return i=>{let p=k(i,r,o);return e(p,t,{...n,depth:s})}}function rt(r,t,n,e){let o=u(r,t,null,n);return e(...o)}function er(r,t,n){return B(r,t)||l(r)&&l(t)?!0:y(r)?r.some(e=>B(e,t))||nt(r,n?.depth).some(e=>B(e,t)):!1}function Tr(r,t,n){return!er(r,t,n)}function me(r,t,n){return l(r)?t.some(e=>e===null):Mt([et(r),t],n?.hashFunction).length>0}function wr(r,t,n){return!me(r,t,n)}function Nr(r,t,n){return vr(r,t,(e,o)=>w(e,o)<0)}function kr(r,t,n){return vr(r,t,(e,o)=>w(e,o)<=0)}function Sr(r,t,n){return vr(r,t,(e,o)=>w(e,o)>0)}function Cr(r,t,n){return vr(r,t,(e,o)=>w(e,o)>=0)}function cn(r,t,n){return et(r).some((e=>t.length===2&&e%t[0]===t[1]))}function ln(r,t,n){let e=et(r),o=s=>h(s)&&Q(t.exec(s),n?.useStrictMode);return e.some(o)||nt(e,1).some(o)}function fn(r,t,n){if(!y(r)||!y(t)||!r.length||!t.length)return!1;let e=!0;for(let o of t){if(!e)break;j(o)&&Object.keys(o).includes("$elemMatch")?e=ue(r,o.$elemMatch,n):H(o)?e=r.some(s=>typeof s=="string"&&o.test(s)):e=r.some(s=>B(o,s))}return e}function yn(r,t,n){return Array.isArray(r)&&r.length===t}function ps(r){return J(r)&&["$and","$or","$nor"].indexOf(r)===-1}function ue(r,t,n){if(y(r)&&!Y(r)){let e=i=>i,o=t;Object.keys(t).every(ps)&&(o={temp:t},e=i=>({temp:i}));let s=new X(o,n);for(let i=0,p=r.length;i<p;i++)if(s.test(e(r[i])))return!0}return!1}var mn=r=>r===null,as={array:y,boolean:ft,bool:ft,date:S,number:b,int:b,long:b,double:b,decimal:b,null:mn,object:j,regexp:H,regex:H,string:h,undefined:l,1:b,2:h,3:j,4:y,6:l,8:ft,9:S,10:mn,11:H,16:b,18:b,19:b};function un(r,t,n){let e=as[t];return e?e(r):!1}function On(r,t,n){return y(t)?t.findIndex(e=>un(r,e,n))>=0:un(r,t,n)}function vr(r,t,n){return et(r).some(e=>q(e)===q(t)&&n(e,t))}var ms=(r,t,n)=>rt(r,t,n,wr);var us=(r,t,n)=>{let e=u(r,t,null,n),o=e[0],s=e[1],i=e[2]||1,p=new Array,a=o;for(;a<s&&i>0||a>s&&i<0;)p.push(a),a+=i;return p};var cs=(r,t,n)=>{let e=I.init(n),o=u(r,t.input,null,e),s=u(r,t.initialValue,null,e),i=t.in;return l(o)?null:(m(y(o),"$reduce 'input' expression must resolve to an array"),o.reduce((p,a)=>u(a,i,null,e.update(e.root,{variables:{value:p}})),s))};var ls=(r,t,n)=>{let e=u(r,t,null,n);if(l(e))return null;m(y(e),"$reverseArray expression must resolve to an array");let o=e.slice(0);return o.reverse(),o};var fs=(r,t,n)=>{let e=u(r,t,null,n);return y(e)?e.length:void 0};var ce=(r,t,n)=>{let e=u(r,t,null,n),o=e[0],s=e[1],i=e[2];return l(i)?s<0?s=Math.max(0,o.length+s):(i=s,s=0):(s<0&&(s=Math.max(0,o.length+s)),m(i>0,"Invalid argument for $slice operator. Limit must be a positive number"),i+=s),o.slice(s,i)};var ys=(r,t,n)=>{let{input:e,sortBy:o}=u(r,t,null,n);if(l(e))return null;if(m(y(e),"$sortArray expression must resolve to an array"),j(o))return Z(N(e),o,n).value();let s=[...e];return s.sort(w),o===-1&&s.reverse(),s};var Os=(r,t,n)=>{let e=u(r,t.inputs,null,n),o=t.useLongestLength||!1;if(l(e))return null;m(y(e),"'inputs' expression must resolve to an array"),m(ft(o),"'useLongestLength' must be a boolean"),y(t.defaults)&&m(o,"'useLongestLength' must be set to true to use 'defaults'");let s=0;for(let a of e){if(l(a))return null;m(y(a),"'inputs' expression values must resolve to an array or null"),s=o?Math.max(s,a.length):Math.min(s||a.length,a.length)}let i=[],p=t.defaults||[];for(let a=0;a<s;a++){let c=e.map((f,O)=>l(f[a])?p[O]||null:f[a]);i.push(c)}return i};function Vt(r,t,n,e){m(y(t),"expression must be an array.");let o=u(r,t,null,n);return o.some(l)?null:(m(o.every(b),"expression must evalue to array of numbers."),e(o))}var As=(r,t,n)=>Vt(r,t,n,e=>e.reduce((o,s)=>o&s,-1));var bs=(r,t,n)=>{let e=u(r,t,null,n);return l(e)?null:(m(b(e),"$bitNot: expression must evaluate to a number."),~e)};var ds=(r,t,n)=>Vt(r,t,n,e=>e.reduce((o,s)=>o|s,0));var xs=(r,t,n)=>Vt(r,t,n,e=>e.reduce((o,s)=>o^s,0));var nr={};lt(nr,{$and:()=>An,$not:()=>bn,$or:()=>dn});var An=(r,t,n)=>{let e=u(r,t,null,n);return Q(e,n.useStrictMode)&&e.every(o=>Q(o,n.useStrictMode))};var bn=(r,t,n)=>{let e=et(t);return e.length==0?!1:(m(e.length==1,"Expression $not takes exactly 1 argument"),!u(r,e[0],null,n))};var dn=(r,t,n)=>{let e=u(r,t,null,n),o=n.useStrictMode;return Q(e,o)&&e.some(s=>Q(s,o))};var or={};lt(or,{$cmp:()=>xn,$eq:()=>gn,$gt:()=>hn,$gte:()=>jn,$lt:()=>En,$lte:()=>$n,$ne:()=>In});var xn=(r,t,n)=>{let e=u(r,t,null,n);return m(y(e)&&e.length==2,"$cmp: expression must resolve to array of size 2."),w(e[0],e[1])};var gn=(r,t,n)=>rt(r,t,n,er);var hn=(r,t,n)=>rt(r,t,n,Sr);var jn=(r,t,n)=>rt(r,t,n,Cr);var En=(r,t,n)=>rt(r,t,n,Nr);var $n=(r,t,n)=>rt(r,t,n,kr);var In=(r,t,n)=>rt(r,t,n,Tr);var gs=(r,t,n)=>{let e,o,s,i="$cond: invalid arguments";y(t)?(m(t.length===3,i),e=t[0],o=t[1],s=t[2]):(m(j(t),i),e=t.if,o=t.then,s=t.else);let p=Q(u(r,e,null,n),n.useStrictMode);return u(r,p?o:s,null,n)};var le=(r,t,n)=>{let e=u(r,t,null,n);return e.find(o=>!l(o))??e[e.length-1]};var hs=(r,t,n)=>{let e=null;return t.branches.some(o=>{let s=Q(u(r,o.case,null,n),n.useStrictMode);return s&&(e=o.then),s}),u(r,e!==null?e:t.default,null,n)};var fe=(r,t,n)=>{m(n.scriptEnabled,"$function operator requires 'scriptEnabled' option to be true");let e=u(r,t,null,n);return e.body.apply(null,e.args)};var js=["mon","mon","tue","wed","thu","fri","sat","sun"],Es=-1e9,Wt=7,ye=r=>(r&3)==0&&(r%100!=0||r%400==0),$s=[365,366],Is=[[0,31,59,90,120,151,181,212,243,273,304,334],[0,31,60,91,121,152,182,213,244,274,305,335]],sr=r=>Is[+ye(r.getUTCFullYear())][r.getUTCMonth()]+r.getUTCDate(),Dr=(r,t)=>{let n=r.getUTCDay()||7,e=t.toLowerCase().substring(0,3);return(n-js.lastIndexOf(e)+Wt)%Wt},Tn=r=>(r+Math.floor(r/4)-Math.floor(r/100)+Math.floor(r/400))%7,wn=r=>52+ +(Tn(r)==4||Tn(r-1)==3);function Bt(r){let t=r.getUTCDay()||7,n=Math.floor((10+sr(r)-t)/7);return n<1?wn(r.getUTCFullYear()-1):n>wn(r.getUTCFullYear())?1:n}function Mr(r){return r.getUTCFullYear()-+(r.getUTCMonth()===0&&r.getUTCDate()==1&&r.getUTCDay()<1)}var Et=60,mt={week:6048e5,day:864e5,hour:36e5,minute:6e4,second:1e3,millisecond:1},Pr="%Y-%m-%dT%H:%M:%S.%LZ",Oe=[["year",0,9999],["month",1,12],["day",1,31],["hour",0,23],["minute",0,59],["second",0,59],["millisecond",0,999]];var Lt={"%b":{name:"abbr_month",padding:3,re:/(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)/i},"%B":{name:"full_month",padding:0,re:/(January|February|March|April|May|June|July|August|September|October|November|December)/i},"%Y":{name:"year",padding:4,re:/([0-9]{4})/},"%G":{name:"year",padding:4,re:/([0-9]{4})/},"%m":{name:"month",padding:2,re:/(0[1-9]|1[012])/},"%d":{name:"day",padding:2,re:/(0[1-9]|[12][0-9]|3[01])/},"%j":{name:"day_of_year",padding:3,re:/(0[0-9][1-9]|[12][0-9]{2}|3[0-5][0-9]|36[0-6])/},"%H":{name:"hour",padding:2,re:/([01][0-9]|2[0-3])/},"%M":{name:"minute",padding:2,re:/([0-5][0-9])/},"%S":{name:"second",padding:2,re:/([0-5][0-9]|60)/},"%L":{name:"millisecond",padding:3,re:/([0-9]{3})/},"%w":{name:"day_of_week",padding:1,re:/([0-6])/},"%u":{name:"day_of_week_iso",padding:1,re:/([1-7])/},"%U":{name:"week_of_year",padding:2,re:/([1-4][0-9]?|5[0-3]?)/},"%V":{name:"week_of_year_iso",padding:2,re:/([1-4][0-9]?|5[0-3]?)/},"%z":{name:"timezone",padding:2,re:/(([+-][01][0-9]|2[0-3]):?([0-5][0-9])?)/},"%Z":{name:"minute_offset",padding:3,re:/([+-][0-9]{3})/},"%%":{name:"percent_literal",padding:1,re:/%%/}},Rr=/(%[bBYGmdjHMSLwuUVzZ%])/g,Sn=/%[bBYGmdjHMSLwuUVzZ%]/,Ts=/^[a-zA-Z_]+\/[a-zA-Z_]+$/;function it(r){if(l(r))return 0;if(Ts.test(r)){let o=new Date,s=new Date(o.toLocaleString("en-US",{timeZone:"UTC"}));return(new Date(o.toLocaleString("en-US",{timeZone:r})).getTime()-s.getTime())/6e4}let t=Lt["%z"].re.exec(r);m(!!t,`timezone '${r}' is invalid or not supported.`);let n=parseInt(t[2])||0,e=parseInt(t[3])||0;return(Math.abs(n*Et)+e)*(n<0?-1:1)}function Cn(r){return(r<0?"-":"+")+_r(Math.abs(Math.floor(r/Et)),2)+_r(Math.abs(r)%Et,2)}function at(r,t){r.setUTCMinutes(r.getUTCMinutes()+t)}function P(r,t,n){if(S(r))return r;let e=u(r,t,null,n);if(S(e))return new Date(e);if(b(e))return new Date(e*1e3);m(!!e?.date,`cannot convert ${JSON.stringify(t)} to date`);let o=S(e.date)?new Date(e.date):new Date(e.date*1e3);return e.timezone&&at(o,it(e.timezone)),o}function _r(r,t){return new Array(Math.max(t-String(r).length+1,0)).join("0")+r.toString()}var Nn=r=>{let t=r-Es;return Math.trunc(t/4)-Math.trunc(t/100)+Math.trunc(t/400)};function ws(r,t){return Math.trunc(Nn(t-1)-Nn(r-1)+(t-r)*$s[0])}var zt=(r,t)=>t.getUTCFullYear()-r.getUTCFullYear(),Ur=(r,t)=>t.getUTCMonth()-r.getUTCMonth()+zt(r,t)*12,Fr=(r,t)=>{let n=Math.trunc(r.getUTCMonth()/3);return Math.trunc(t.getUTCMonth()/3)-n+zt(r,t)*4},Qt=(r,t)=>sr(t)-sr(r)+ws(r.getUTCFullYear(),t.getUTCFullYear()),Vr=(r,t,n)=>{let e=(n||"sun").substring(0,3);return Math.trunc((Qt(r,t)+Dr(r,e)-Dr(t,e))/Wt)},vn=(r,t)=>t.getUTCHours()-r.getUTCHours()+Qt(r,t)*24,kn=(r,t)=>{let n=r.getUTCMonth()+t,e=Math.floor(n/12);if(n<0){let o=n%12+12;r.setUTCFullYear(r.getUTCFullYear()+e,o,r.getUTCDate())}else r.setUTCFullYear(r.getUTCFullYear()+e,n%12,r.getUTCDate())},Wr=(r,t,n,e)=>{let o=new Date(r);switch(t){case"year":o.setUTCFullYear(o.getUTCFullYear()+n);break;case"quarter":kn(o,3*n);break;case"month":kn(o,n);break;default:o.setTime(o.getTime()+mt[t]*n)}return o};var kt=(r,t,n)=>{let e=u(r,t,null,n);return Wr(e.startDate,e.unit,e.amount,e.timezone)};var Ns=(r,t,n)=>{let{startDate:e,endDate:o,unit:s,timezone:i,startOfWeek:p}=u(r,t,null,n),a=new Date(e),c=new Date(o),f=it(i);switch(at(a,f),at(c,f),s){case"year":return zt(a,c);case"quarter":return Fr(a,c);case"month":return Ur(a,c);case"week":return Vr(a,c,p);case"day":return Qt(a,c);case"hour":return vn(a,c);case"minute":return a.setUTCSeconds(0),a.setUTCMilliseconds(0),c.setUTCSeconds(0),c.setUTCMilliseconds(0),Math.round((c.getTime()-a.getTime())/mt[s]);default:return Math.round((c.getTime()-a.getTime())/mt[s])}};var ks=[31,28,31,30,31,30,31,31,30,31,30,31],Ss=r=>r.month==2&&ye(r.year)?29:ks[r.month-1],Cs=(r,t,n)=>{let e=u(r,t,null,n),o=it(e.timezone);for(let s=Oe.length-1,i=0;s>=0;s--){let p=Oe[s],a=p[0],c=p[1],f=p[2],O=(e[a]||0)+i;i=0;let A=f+1;if(a=="hour"&&(O+=Math.floor(o/Et)*-1),a=="minute"&&(O+=o%Et*-1),O<c){let d=c-O;i=-1*Math.ceil(d/A),O=A-d%A}else O>f&&(O+=c,i=Math.trunc(O/A),O%=A);e[a]=O}return e.day=Math.min(e.day,Ss(e)),new Date(Date.UTC(e.year,e.month-1,e.day,e.hour,e.minute,e.second,e.millisecond))};function vs(r){return r==="Z"?0:r>="A"&&r<"N"?r.charCodeAt(0)-64:77-r.charCodeAt(0)}var Ds=r=>r.replace(/^\//,"").replace(/\/$/,""),_s=["^",".","-","*","?","$"];function Ms(r){return _s.forEach(t=>{r=r.replace(t,`\\${t}`)}),r}var Ps=(r,t,n)=>{let e=u(r,t,null,n);e.format=e.format||Pr,e.onNull=e.onNull||null;let o=e.dateString;if(l(o))return e.onNull;let s=e.format.split(Sn);s.reverse();let i=e.format.match(Rr),p={},a="";for(let A=0,d=i.length;A<d;A++){let x=i[A],g=Lt[x];if(j(g)){let E=g.re.exec(o),T=s.pop()||"";E!==null?(p[g.name]=/^\d+$/.exec(E[0])?parseInt(E[0]):E[0],o=o.substring(E.index+E[0].length+1),a+=Ms(T)+Ds(g.re.toString())):p[g.name]=null}}if(l(p.year)||l(p.month)||l(p.day)||!new RegExp("^"+a+"[A-Z]?$").exec(e.dateString))return e.onError;let c=e.dateString.match(/([A-Z])$/);m(!(c&&e.timezone),`$dateFromString: you cannot pass in a date/time string with time zone information ('${c&&c[0]}') together with a timezone argument`);let f=c?vs(c[0])*Et:it(e.timezone),O=new Date(Date.UTC(p.year,p.month-1,p.day,0,0,0));return l(p.hour)||O.setUTCHours(p.hour),l(p.minute)||O.setUTCMinutes(p.minute),l(p.second)||O.setUTCSeconds(p.second),l(p.millisecond)||O.setUTCMilliseconds(p.millisecond),at(O,-f),O};var Rs=(r,t,n)=>{let e=u(r,t?.amount,null,n);return kt(r,{...t,amount:-1*e},n)};var Us=(r,t,n)=>{let e=u(r,t,null,n),o=new Date(e.date),s=it(e.timezone);at(o,s);let i={hour:o.getUTCHours(),minute:o.getUTCMinutes(),second:o.getUTCSeconds(),millisecond:o.getUTCMilliseconds()};return e.iso8601==!0?Object.assign(i,{isoWeekYear:Mr(o),isoWeek:Bt(o),isoDayOfWeek:o.getUTCDay()||7}):Object.assign(i,{year:o.getUTCFullYear(),month:o.getUTCMonth()+1,day:o.getUTCDate()})};var Ae=(r,t,n)=>P(r,t,n).getUTCDate();var be=(r,t,n)=>P(r,t,n).getUTCDay()+1;var de=(r,t,n)=>sr(P(r,t,n));var xe=(r,t,n)=>P(r,t,n).getUTCHours();var ge=(r,t,n)=>P(r,t,n).getUTCDay()||7;var he=(r,t,n)=>Bt(P(r,t,n));var je=(r,t,n)=>P(r,t,n).getUTCMilliseconds();var Ee=(r,t,n)=>P(r,t,n).getUTCMinutes();var $e=(r,t,n)=>P(r,t,n).getUTCMonth()+1;var Ie=(r,t,n)=>P(r,t,n).getUTCSeconds();var Te=(r,t,n)=>{let e=P(r,t,n),o=Bt(e);return e.getUTCDay()>0&&e.getUTCDate()==1&&e.getUTCMonth()==0?0:e.getUTCDay()==0?o+1:o};var Br=(r,t,n)=>P(r,t,n).getUTCFullYear();var Fs={"%Y":Br,"%G":Br,"%m":$e,"%d":Ae,"%H":xe,"%M":Ee,"%S":Ie,"%L":je,"%u":ge,"%U":Te,"%V":he,"%j":de,"%w":(r,t,n)=>be(r,t,n)-1},we=(r,t,n)=>{let e=u(r,t,null,n);if(l(e.onNull)&&(e.onNull=null),l(e.date))return e.onNull;let o=P(r,e.date,n),s=e.format||Pr,i=it(e.timezone),p=s.match(Rr);at(o,i);for(let a=0,c=p.length;a<c;a++){let f=p[a];m(f in Lt,`$dateToString: invalid format specifier ${f}`);let{name:O,padding:A}=Lt[f],d=Fs[f],x;if(d)x=_r(d(r,o,n),A);else switch(O){case"timezone":x=Cn(i);break;case"minute_offset":x=i.toString();break;case"abbr_month":case"full_month":{let g=O.startsWith("abbr")?"short":"long";x=o.toLocaleString("en-US",{month:g});break}}s=s.replace(f,x)}return s};var ir=["year","quarter","month","week","day","hour","minute","second","millisecond"];var Dn=9466848e5,_n=(r,t)=>{let n=r%t;return n<0&&(n+=t),n},Vs={day:Qt,month:Ur,quarter:Fr,year:zt},Ws=/(mon(day)?|tue(sday)?|wed(nesday)?|thu(rsday)?|fri(day)?|sat(urday)?|sun(day)?)/i,Bs=(r,t,n)=>{let{date:e,unit:o,binSize:s,timezone:i,startOfWeek:p}=u(r,t,null,n);if(l(e)||l(o))return null;let a=(p??"sun").toLowerCase().substring(0,3);m(S(e),"$dateTrunc: 'date' must resolve to a valid Date object."),m(ir.includes(o),"$dateTrunc: unit is invalid."),m(o!="week"||Ws.test(a),`$dateTrunc: startOfWeek '${a}' is not a valid.`),m(l(s)||s>0,"$dateTrunc requires 'binSize' to be greater than 0, but got value 0.");let c=s??1;switch(o){case"millisecond":case"second":case"minute":case"hour":{let f=c*mt[o],O=e.getTime()-Dn;return new Date(e.getTime()-_n(O,f))}default:{m(c<=1e11,"dateTrunc unsupported binSize value");let f=new Date(e),O=new Date(Dn),A=0;if(o=="week"){let E=Dr(O,a),T=(Wt-E)%Wt;O.setTime(O.getTime()+T*mt.day),A=Vr(O,f,a)}else A=Vs[o](O,f);let d=A-_n(A,c),x=Wr(O,o,d,i),g=it(i);return at(x,-g),x}}};var Ls=(r,t,n)=>Mr(P(r,t,n));var zs=(r,t,n)=>t;var Qs=(r,t,n)=>{let e=u(r,t.input,null,n);return ne(e,{input:"$$CURRENT"},n)};var Ks=(r,t,n)=>{let e=u(r,t,null,n),[o,s]=j(e)?[e.field,e.input||r]:[e,r];return l(s)?null:(m(j(s),"$getField expression 'input' must evaluate to an object"),m(h(o),"$getField expression 'field' must evaluate to a string"),s[o])};var qs=(r,t,n)=>Math.random();var Ys=(r,t,n)=>Math.random()<=u(r,t,null,n);var Ne=(r,t,n)=>{let e=u(r,t,null,n)??[];return oe(e,t,n)};var Hs=(r,t,n)=>{let e=u(r,t,null,n);if(l(e))return null;m(j(e),`$objectToArray requires a document input, found: ${q(e)}`);let o=Object.entries(e),s=new Array(o.length),i=0;for(let[p,a]of o)s[i++]={k:p,v:a};return s};var ke=(r,t,n)=>{let{input:e,field:o,value:s}=u(r,t,null,n);if(l(e))return null;m(j(e),"$setField expression 'input' must evaluate to an object"),m(h(o),"$setField expression 'field' must evaluate to a string");let i={...e};return t.value=="$$REMOVE"?delete i[o]:i[o]=s,i};var Gs=(r,t,n)=>ke(r,{...t,value:"$$REMOVE"},n);var Js=(r,t,n)=>{let e=u(r,t.input,null,n);return tr(e,{...t,input:"$$CURRENT"},n)};var Xs=(r,t,n)=>u(r,t,null,n)[0].every(o=>Q(o,n.useStrictMode));var Zs=(r,t,n)=>u(r,t,null,n)[0].some(o=>Q(o,n.useStrictMode));var ti=(r,t,n)=>{let e=u(r,t,null,n);if(l(e)||(m(y(e),"$setDifference must be an arrays."),e.some(l)))return null;m(e.length==2,"$setDifference takes exactly 2 arguments."),m(e.every(y),"$setDifference operands must be arrays.");let o=z.init(n.hashFunction);return e[0].forEach(s=>o.set(s,!0)),e[1].forEach(s=>o.delete(s)),Array.from(o.keys())};var ri=(r,t,n)=>{let e=u(r,t,null,n);m(y(e)&&e.every(y),"$setEquals operands must be arrays.");let o=z.init();e[0].every((s,i)=>o.set(s,i));for(let s=1;s<e.length;s++){let i=e[s],p=new Set;for(let a=0;a<i.length;a++){let c=o.get(i[a])??-1;if(c===-1)return!1;p.add(c)}if(p.size!==o.size)return!1}return!0};var ei=(r,t,n)=>{let e=u(r,t,null,n);return l(e)?null:(m(y(e)&&e.every(y),"$setIntersection operands must be arrays."),Mt(e,n?.hashFunction))};var ni=(r,t,n)=>{let e=u(r,t,null,n);m(y(e)&&e.every(y),"$setIsSubset operands must be arrays.");let o=e[0],s=e[1],i=z.init(),p=new Set;o.every((a,c)=>i.set(a,c));for(let a of s)if(p.add(i.get(a)??-1),p.size>i.size)return!0;return p.delete(-1),p.size==i.size};var oi=(r,t,n)=>{let e=u(r,t,null,n);return l(e)||(m(y(e),"$setUnion operands must be arrays."),e.some(l))?null:Pt(nt(e),n?.hashFunction)};var si=(r,t,n)=>{let e=u(r,t,null,n);return m(e.every(o=>h(o)||l(o)),"$concat only supports strings."),e.some(l)?null:e.join("")};var ii=(r,t,n)=>{let e=u(r,t,null,n),o="$indexOfBytes expression resolves to invalid an argument";if(l(e[0]))return null;m(h(e[0])&&h(e[1]),o);let s=e[0],i=e[1],p=e[2],a=e[3],c=l(p)||b(p)&&p>=0&&Math.round(p)===p;if(c=c&&(l(a)||b(a)&&a>=0&&Math.round(a)===a),m(c,o),p=p||0,a=a||s.length,p>a)return-1;let f=s.substring(p,a).indexOf(i);return f>-1?f+p:f};var pi=[0,32,9,10,11,12,13,160,5760,8192,8193,8194,8195,8196,8197,8198,8199,8200,8201,8202];function Kt(r,t,n,e){let o=u(r,t,null,n),s=o.input;if(l(s))return null;let i=l(o.chars)?pi:o.chars.split("").map(c=>c.codePointAt(0)),p=0,a=s.length-1;for(;e.left&&p<=a&&i.indexOf(s[p].codePointAt(0))!==-1;)p++;for(;e.right&&p<=a&&i.indexOf(s[a].codePointAt(0))!==-1;)a--;return s.substring(p,a+1)}function qt(r,t,n,e){let o=u(r,t,null,n);if(!h(o.input))return[];let s=o.options;s&&(m(s.indexOf("x")===-1,"extended capability option 'x' not supported"),m(s.indexOf("g")===-1,"global option 'g' not supported"));let i=o.input,p=new RegExp(o.regex,s),a,c=new Array,f=0;for(;a=p.exec(i);){let O={match:a[0],idx:a.index+f,captures:[]};for(let A=1;A<a.length;A++)O.captures.push(a[A]||null);if(c.push(O),!e.global)break;f=a.index+a[0].length,i=i.substring(f)}return c}var ai=(r,t,n)=>Kt(r,t,n,{left:!0,right:!1});var mi=(r,t,n)=>{let e=qt(r,t,n,{global:!1});return e&&e.length>0?e[0]:null};var ui=(r,t,n)=>qt(r,t,n,{global:!0});var ci=(r,t,n)=>qt(r,t,n,{global:!1}).length!=0;var li=(r,t,n)=>{let e=u(r,t,null,n),o=[e.input,e.find,e.replacement];return o.some(l)?null:(m(o.every(h),"$replaceAll expression fields must evaluate to string"),e.input.replace(new RegExp(e.find,"g"),e.replacement))};var fi=(r,t,n)=>{let e=u(r,t,null,n),o=[e.input,e.find,e.replacement];return o.some(l)?null:(m(o.every(h),"$replaceOne expression fields must evaluate to string"),e.input.replace(e.find,e.replacement))};var yi=(r,t,n)=>Kt(r,t,n,{left:!1,right:!0});var Oi=(r,t,n)=>{let e=u(r,t,null,n);return l(e[0])?null:(m(e.every(h),"$split expression must result to array(2) of strings"),e[0].split(e[1]))};var Ai=(r,t,n)=>{let e=u(r,t,null,n),o=e[0],s=e[1];return B(o,s)||e.every(l)?0:(m(e.every(h),"$strcasecmp must resolve to array(2) of strings"),o=o.toUpperCase(),s=s.toUpperCase(),o>s&&1||o<s&&-1||0)};var bi=(r,t,n)=>~-encodeURI(u(r,t,null,n)).split(/%..|./).length;var di=(r,t,n)=>u(r,t,null,n).length;var Se=(r,t,n)=>{let[e,o,s]=u(r,t,null,n);return o<0||!h(e)?"":s<0?e.substring(o):e.substring(o,o+s)};var xi=[192,224,240];function gi(r){if(r<128)return[r];let t=r<2048&&1||r<65536&&2||3,n=xi[t-1],e=[(r>>6*t)+n];for(;t>0;)e.push(128|r>>6*--t&63);return e}function hi(r){let t=[];for(let n=0,e=r.length;n<e;n++)t.push(gi(r.codePointAt(n)));return t}var ji=(r,t,n)=>{let e=u(r,t,null,n),o=e[0],s=e[1],i=e[2];m(h(o)&&b(s)&&s>=0&&b(i)&&i>=0,"$substrBytes: invalid arguments");let p=hi(o),a=[],c=0;for(let A=0;A<p.length;A++)a.push(c),c+=p[A].length;let f=a.indexOf(s),O=a.indexOf(s+i);return m(f>-1&&O>-1,"$substrBytes: invalid range, start or end index is a UTF-8 continuation byte."),o.substring(f,O)};var Ei=(r,t,n)=>Se(r,t,n);var $i=(r,t,n)=>{let e=u(r,t,null,n);return Y(e)?"":e.toLowerCase()};var Ii=(r,t,n)=>{let e=u(r,t,null,n);return Y(e)?"":e.toUpperCase()};var Ti=(r,t,n)=>Kt(r,t,n,{left:!0,right:!0});var wi=(r,t,n)=>Zt(u(r,t,null,n),n.hashFunction);function R(r,t,n,e,o){let s={undefined:null,null:null,NaN:NaN,Infinity:new Error,"-Infinity":new Error,...o},i=u(r,t,null,n);if(i in s){let p=s[i],a=p instanceof Error;return m(!a,`$${e.name}: value must be in range (-inf,inf)`),!a&&p}return e(i)}var Ni=(r,t,n)=>R(r,t,n,Math.acos,{Infinity:1/0,0:new Error});var ki=(r,t,n)=>R(r,t,n,Math.acosh,{Infinity:1/0,0:new Error});var Si=(r,t,n)=>R(r,t,n,Math.asin);var Ci=(r,t,n)=>R(r,t,n,Math.asinh,{Infinity:1/0,"-Infinity":-1/0});var vi=(r,t,n)=>R(r,t,n,Math.atan);var Di=(r,t,n)=>{let[e,o]=u(r,t,null,n);return isNaN(e)||l(e)?e:isNaN(o)||l(o)?o:Math.atan2(e,o)};var _i=(r,t,n)=>R(r,t,n,Math.atanh,{1:1/0,"-1":-1/0});var Mi=(r,t,n)=>R(r,t,n,Math.cos);var Pi=(r,t,n)=>R(r,t,n,Math.cosh,{"-Infinity":1/0,Infinity:1/0});var Ri=r=>r*(Math.PI/180),Ui=(r,t,n)=>R(r,t,n,Ri,{Infinity:1/0,"-Infinity":1/0});var Fi=r=>r*(180/Math.PI),Vi=(r,t,n)=>R(r,t,n,Fi,{Infinity:1/0,"-Infinity":1/0});var Wi=(r,t,n)=>R(r,t,n,Math.sin);var Bi=(r,t,n)=>R(r,t,n,Math.sinh,{"-Infinity":-1/0,Infinity:1/0});var Li=(r,t,n)=>R(r,t,n,Math.tan);var zi=(r,t,n)=>R(r,t,n,Math.tanh,{Infinity:1,"-Infinity":-1});var Ce=(r,t,n)=>{let e=u(r,t,null,n);return l(e)?null:h(e)?!0:!!e};var ve=(r,t,n)=>{let e=u(r,t,null,n);if(S(e))return e;if(l(e))return null;let o=new Date(e);return m(!isNaN(o.getTime()),`cannot convert '${e}' to date`),o};var pr=(r,t,n)=>{let e=u(r,t,null,n);if(l(e))return null;if(S(e))return e.getTime();if(e===!0)return 1;if(e===!1)return 0;let o=Number(e);return m(b(o),`cannot convert '${e}' to double/decimal`),o};var ar=2147483647,Lr=-2147483648,Mn=9007199254740991,Pn=-9007199254740991;function zr(r,t,n,e,o){let s=u(r,t,null,n);if(s===!0)return 1;if(s===!1)return 0;if(l(s))return null;if(S(s))return s.getTime();let i=Number(s);return m(b(i)&&i>=e&&i<=o&&(!h(s)||i.toString().indexOf(".")===-1),`cannot convert '${s}' to ${o==ar?"int":"long"}`),Math.trunc(i)}var De=(r,t,n)=>zr(r,t,n,Lr,ar);var _e=(r,t,n)=>zr(r,t,n,Pn,Mn);var Me=(r,t,n)=>{let e=u(r,t,null,n);return l(e)?null:S(e)?we(r,{date:t,format:"%Y-%m-%dT%H:%M:%S.%LZ"},n):e.toString()};var Qi=(r,t,n)=>{let e=u(r,t,null,n);if(e.onNull=e.onNull===void 0?null:e.onNull,l(e.input))return e.onNull;try{switch(e.to){case 2:case"string":return Me(r,e.input,n);case 8:case"boolean":case"bool":return Ce(r,e.input,n);case 9:case"date":return ve(r,e.input,n);case 1:case 19:case"double":case"decimal":case"number":return pr(r,e.input,n);case 16:case"int":return De(r,e.input,n);case 18:case"long":return _e(r,e.input,n)}}catch{}return m(e.onError!==void 0,`could not convert to type ${e.to}.`),e.onError};var Ki=(r,t,n)=>{let e=u(r,t,null,n);return b(e)};var qi=pr;var Yi=(r,t,n)=>{let e=u(r,t,null,n);if(n.useStrictMode){if(e===void 0)return"missing";if(e===!0||e===!1)return"bool";if(b(e))return e%1!=0?"double":e>=Lr&&e<=ar?"int":"long";if(H(e))return"regex"}return q(e)};var Hi=(r,t,n)=>{let e={};for(let[o,s]of Object.entries(t.vars))e[o]=u(r,s,null,n);return u(r,t.in,null,I.init(n,r,{variables:e}))};var Le={};lt(Le,{$addFields:()=>St,$bucket:()=>Gi,$bucketAuto:()=>Ji,$count:()=>ep,$densify:()=>np,$documents:()=>Re,$facet:()=>op,$fill:()=>mp,$graphLookup:()=>up,$group:()=>ur,$limit:()=>pe,$lookup:()=>We,$match:()=>Tp,$merge:()=>wp,$out:()=>Np,$project:()=>rr,$redact:()=>kp,$replaceRoot:()=>Sp,$replaceWith:()=>Cp,$sample:()=>vp,$set:()=>Dp,$setWindowFields:()=>Ve,$skip:()=>ae,$sort:()=>Z,$sortByCount:()=>_p,$unionWith:()=>Mp,$unset:()=>Pp,$unwind:()=>Rp});var St=(r,t,n)=>{let e=Object.keys(t);return e.length===0?r:r.map((o=>{let s={...o};for(let i of e){let p=u(o,t[i],null,n);p!==void 0?jt(s,i,p):Tt(s,i)}return s}))};var Gi=(r,t,n)=>{let e=[...t.boundaries],o=t.default,s=e[0],i=e[e.length-1],p=t.output||{count:{$sum:1}};m(e.length>1,"$bucket: must specify at least two boundaries.");let a=e.every((O,A)=>A===0||q(O)===q(e[A-1])&&w(O,e[A-1])>0);m(a,"$bucket: bounds must be of same type and in ascending order"),m(l(o)||q(o)!==q(s)||w(o,i)>=0||w(o,s)<0,"$bucket: 'default' expression must be out of boundaries range");let c=()=>{let O=new Map;for(let A=0;A<e.length-1;A++)O.set(e[A],[]);return l(o)||O.set(o,[]),r.each(A=>{let d=u(A,t.groupBy,null,n);if(l(d)||w(d,s)<0||w(d,i)>=0)m(!l(o),"$bucket require a default for out of range values"),O.get(o).push(A);else{m(w(d,s)>=0&&w(d,i)<0,"$bucket 'groupBy' expression must resolve to a value in range of boundaries");let x=Ut(e,d),g=e[Math.max(0,x-1)];O.get(g).push(A)}}),e.pop(),l(o)||(O.get(o).length?e.push(o):O.delete(o)),m(O.size===e.length,"bounds and groups must be of equal size."),N(e).map(A=>({...u(O.get(A),p,null,n),_id:A}))},f;return N(()=>(f||(f=c()),f.next()))};var Ji=(r,t,n)=>{let{buckets:e,groupBy:o,output:s,granularity:i}=t,p=s??{count:{$sum:1}};m(e>0,`$bucketAuto: 'buckets' field must be greater than 0, but found: ${e}`),i&&m(/^(POWERSOF2|1-2-5|E(6|12|24|48|96|192)|R(5|10|20|40|80))$/.test(i),`$bucketAuto: invalid granularity '${i}'.`);let a=new Map,c=i?(d,x)=>{}:(d,x)=>a.set(d,x),f=r.map(d=>{let x=u(d,o,null,n)??null;return m(!i||b(x),"$bucketAuto: groupBy values must be numeric when granularity is specified."),c(d,x??null),[x??null,d]}).value();f.sort((d,x)=>l(d[0])?-1:l(x[0])?1:w(d[0],x[0]));let O;i?i=="POWERSOF2"?O=Zi(f,e):O=rp(f,e,i):O=Xi(f,e,a);let A=!1;return N(()=>{if(A)return{done:!0};let{min:d,max:x,bucket:g,done:E}=O();A=E;let T=u(g,p,null,n);for(let[F,D]of Object.entries(T))y(D)&&(T[F]=D.filter(L=>L!==void 0));return{done:!1,value:{...T,_id:{min:d,max:x}}}})};function Xi(r,t,n){let e=r.length,o=Math.max(1,Math.round(r.length/t)),s=0,i=0;return()=>{let p=++i==t,a=new Array;for(;s<e&&(p||a.length<o||s>0&&B(r[s-1][0],r[s][0]));)a.push(r[s++][1]);let c=n.get(a[0]),f;return s<e?f=r[s][0]:f=n.get(a[a.length-1]),m(l(f)||l(c)||c<=f,"error: $bucketAuto boundary must be in order."),{min:c,max:f,bucket:a,done:s>=e}}}function Zi(r,t){let n=r.length,e=Math.max(1,Math.round(r.length/t)),o=a=>a===0?0:2**(Math.floor(Math.log2(a))+1),s=0,i=0,p=0;return()=>{let a=new Array,c=o(p);for(i=s>0?p:0;a.length<e&&s<n&&(p===0||r[s][0]<c);)a.push(r[s++][1]);for(p=p==0?o(r[s-1][0]):c;s<n&&r[s][0]<p;)a.push(r[s++][1]);return{min:i,max:p,bucket:a,done:s>=n}}}var tp={R5:[10,16,25,40,63],R10:[100,125,160,200,250,315,400,500,630,800],R20:[100,112,125,140,160,180,200,224,250,280,315,355,400,450,500,560,630,710,800,900],R40:[100,106,112,118,125,132,140,150,160,170,180,190,200,212,224,236,250,265,280,300,315,355,375,400,425,450,475,500,530,560,600,630,670,710,750,800,850,900,950],R80:[103,109,115,122,128,136,145,155,165,175,185,195,206,218,230,243,258,272,290,307,325,345,365,387,412,437,462,487,515,545,575,615,650,690,730,775,825,875,925,975],"1-2-5":[10,20,50],E6:[10,15,22,33,47,68],E12:[10,12,15,18,22,27,33,39,47,56,68,82],E24:[10,11,12,13,15,16,18,20,22,24,27,30,33,36,39,43,47,51,56,62,68,75,82,91],E48:[100,105,110,115,121,127,133,140,147,154,162,169,178,187,196,205,215,226,237,249,261,274,287,301,316,332,348,365,383,402,422,442,464,487,511,536,562,590,619,649,681,715,750,787,825,866,909,953],E96:[100,102,105,107,110,113,115,118,121,124,127,130,133,137,140,143,147,150,154,158,162,165,169,174,178,182,187,191,196,200,205,210,215,221,226,232,237,243,249,255,261,267,274,280,287,294,301,309,316,324,332,340,348,357,365,374,383,392,402,412,422,432,442,453,464,475,487,499,511,523,536,549,562,576,590,604,619,634,649,665,681,698,715,732,750,768,787,806,825,845,866,887,909,931,953,976],E192:[100,101,102,104,105,106,107,109,110,111,113,114,115,117,118,120,121,123,124,126,127,129,130,132,133,135,137,138,140,142,143,145,147,149,150,152,154,156,158,160,162,164,165,167,169,172,174,176,178,180,182,184,187,189,191,193,196,198,200,203,205,208,210,213,215,218,221,223,226,229,232,234,237,240,243,246,249,252,255,258,261,264,267,271,274,277,280,284,287,291,294,298,301,305,309,312,316,320,324,328,332,336,340,344,348,352,357,361,365,370,374,379,383,388,392,397,402,407,412,417,422,427,432,437,442,448,453,459,464,470,475,481,487,493,499,505,511,517,523,530,536,542,549,556,562,569,576,583,590,597,604,612,619,626,634,642,649,657,665,673,681,690,698,706,715,723,732,741,750,759,768,777,787,796,806,816,825,835,845,856,866,876,887,898,909,920,931,942,953,965,976,988]},Rn=(r,t)=>{if(r==0)return 0;let n=tp[t],e=n[0],o=n[n.length-1],s=1;for(;r>=o*s;)s*=10;let i=0;for(;r<e*s;)if(i=e*s,s/=10,r>=o*s)return i;m(r>=e*s&&r<o*s,"$bucketAuto: number out of range of series.");let p=Ut(n,r,(c,f)=>(f*=s,c<f?-1:c>f?1:0)),a=n[p]*s;return r==a?n[p+1]*s:a};function rp(r,t,n){let e=r.length,o=Math.max(1,Math.round(r.length/t)),s=0,i=0,p=0,a=0;return()=>{let c=++i==t,f=new Array;for(p=s>0?a:0;s<e&&(c||f.length<o);)f.push(r[s++][1]);a=Rn(r[s-1][0],n);let O=f.length;for(;s<e&&(c||r[s][0]<a);)f.push(r[s++][1]);return O!=f.length&&(a=Rn(r[s-1][0],n)),m(p<a,`$bucketAuto: ${p} < ${a}.`),{min:p,max:a,bucket:f,done:s>=e}}}var ep=(r,t,n)=>(m(h(t)&&!Y(t)&&t.indexOf(".")===-1&&t.trim()[0]!=="$","Invalid expression value for $count"),N([{[t]:r.size()}]));var np=(r,t,n)=>{let{step:e,bounds:o,unit:s}=t.range;s?(m(ir.includes(s),""),m(Number.isInteger(e)&&e>0,"The step parameter in a range statement must be a whole number when densifying a date range.")):m(b(e)&&e>0,"The step parameter in a range statement must be a strictly positive numeric value."),y(o)&&(m(!!o&&o.length===2,"A bounding array in a range statement must have exactly two elements."),m((o.every(b)||o.every(S))&&o[0]<o[1],"A bounding array must be an ascending array of either two dates or two numbers."),m(s&&!o.some(b),"Numeric bounds may not have unit parameter.")),t.partitionByFields&&m(y(t.partitionByFields),"$densify: `partitionByFields` must be an array of strings"),r=Z(r,{[t.field]:1},n);let i=I.init(n,null),p=_=>b(_)?_+e:kt(null,{startDate:_,unit:s,amount:e},i),a=!!s&&ir.includes(s),c=_=>{let W=k(_,t.field);return m(l(W)||S(W)&&a||b(W)&&!a,"$densify: Densify field type must be numeric with 'unit' unspecified, or a date with 'unit' specified."),W},f=new Array,O=N(()=>{let _=r.next(),W=c(_.value);return l(W)?_:(f.push(_),{done:!0})}),A=z.init(n.hashFunction),[d,x]=y(o)?o:[o,o],g,E=_=>{g=g===void 0||g<_?_:g},T=[],F=N(()=>{let _=f.length>0?f.pop():r.next();if(_.done)return _;let W=T;y(t.partitionByFields)&&(W=t.partitionByFields.map(It=>k(_.value,It)),m(W.every(h),"$densify: Partition fields must evaluate to string values.")),m(j(_.value),"$densify: collection must contain documents");let ct=c(_.value);A.has(W)||(d=="full"?(A.has(T)||A.set(T,ct),A.set(W,A.get(T))):d=="partition"?A.set(W,ct):A.set(W,d));let K=A.get(W);if(ct<=K||x!="full"&&x!="partition"&&K>=x)return K<=ct&&A.set(W,p(K)),E(ct),_;A.set(W,p(K)),E(K);let At={[t.field]:K};return W&&W.forEach((It,Ht)=>{At[t.partitionByFields[Ht]]=It}),f.push(_),{done:!1,value:At}});if(d!=="full")return dt(O,F);let D=-1,L,ut=N(()=>{if(D===-1){let _=A.get(T);A.delete(T),L=Array.from(A.keys()),L.length===0&&(L.push(T),A.set(T,_)),D++}do{let _=L[D],W=A.get(_);if(W<g){A.set(_,p(W));let ct={[t.field]:W};return _.forEach((K,At)=>{ct[t.partitionByFields[At]]=K}),{done:!1,value:ct}}D++}while(D<L.length);return{done:!0}});return dt(O,F,ut)};var Re=(r,t,n)=>{let e=u(null,t,null,n);m(y(e),"$documents: expression must resolve to an array.");let o=N(e);return n.processingMode&3?o.map(G):o};var op=(r,t,n)=>r.transform((e=>{let o={};for(let[s,i]of Object.entries(t))o[s]=new pt(i,{...n,processingMode:1}).run(e);return[o]}));var mr=new WeakMap;function xt(r,t,n,e){mr.has(r)||mr.set(r,{});let o=mr.get(r);t.field in o||(o[t.field]=n());let s=!1;try{let i=e(o[t.field]);return s=!0,i}finally{s?t.documentNumber===r.length&&(delete o[t.field],Object.keys(o).length===0&&mr.delete(r)):mr.delete(r)}}function Qr(r,t,n,e,o){return xt(t,n,()=>{let s="$"+Object.keys(n.parentExpr.sortBy)[0],i=$(t,s,e),p=Rt(i,((f,O)=>i[O]),e.hashFunction),a=0,c=0;for(let f of p.keys()){let O=p.get(f).length;p.set(f,[a++,c]),c+=O}return{values:i,groups:p}},({values:s,groups:i})=>{if(i.size==t.length)return n.documentNumber;let p=s[n.documentNumber-1],[a,c]=i.get(p);return(o?a:c)+1})}var sp=(r,t,n,e,o)=>t+(o-r)*((e-t)/(n-r)),Ue=(r,t,n,e)=>xt(t,n,()=>{let o="$"+Object.keys(n.parentExpr.sortBy)[0],s=$(t,[o,n.inputExpr],e).filter((([a,c])=>b(+a)));if(s.length!==t.length)return null;let i=-1,p=0;for(;p<s.length;){for(;i+1<s.length&&b(s[i+1][1]);)i++,p=i;for(;p+1<s.length&&!b(s[p+1][1]);)p++;if(p+1>=s.length)break;for(p++;i+1<p;)s[i+1][1]=sp(s[i][0],s[i][1],s[p][0],s[p][1],s[i+1][0]),i++;i=p}return s.map(([a,c])=>c)},o=>o[n.documentNumber-1]);var Fe=(r,t,n,e)=>xt(t,n,()=>{let o=$(t,n.inputExpr,e);for(let s=1;s<o.length;s++)l(o[s])&&(o[s]=o[s-1]);return o},o=>o[n.documentNumber-1]);var Kr="_id",ur=(r,t,n)=>{m(M(t,Kr),"$group specification must include an '_id'");let e=t[Kr],o=I.init(n),s=Object.keys(t).filter(i=>i!=Kr);return r.transform((i=>{let p=Rt(i,f=>u(f,e,null,n),n.hashFunction),a=-1,c=Array.from(p.keys());return()=>{if(++a===p.size)return{done:!0};let f=c[a],O={};f!==void 0&&(O[Kr]=f);for(let A of s)O[A]=u(p.get(f),t[A],null,o.update(null,{groupId:f}));return{value:O,done:!1}}}))};var Un=new Set(["$denseRank","$documentNumber","$first","$last","$linearFill","$rank","$shift"]),ip=new Set(["$denseRank","$expMovingAvg","$linearFill","$locf","$rank","$shift"]),pp=r=>{let t=r?.documents||r?.range;return!t||t[0]==="unbounded"&&t[1]==="unbounded"},Ve=(r,t,n)=>{n=yt(n),n.context.addExpressionOps({$function:fe});for(let e of Object.values(t.output)){let o=Object.keys(e),s=o.find(J);if(m(!!st("window",s,n)||!!st("accumulator",s,n),`'${s}' is not a valid window operator`),m(o.length>0&&o.length<=2&&(o.length==1||o.includes("window")),"'output' option should have a single window operator."),e?.window){let{documents:i,range:p}=e.window;m((+!!i^+!!p)===1,"'window' option supports only one of 'documents' or 'range'.")}}return t.sortBy&&(r=Z(r,t.sortBy,n)),r=ur(r,{_id:t.partitionBy,items:{$push:"$$CURRENT"}},n),r.transform((e=>{let o=[],s=[];for(let[i,p]of Object.entries(t.output)){let a=Object.keys(p).find(J),c={operatorName:a,func:{left:st("accumulator",a,n),right:st("window",a,n)},args:p[a],field:i,window:p.window};m(!!t.sortBy||!(Un.has(a)||!c.window),`${Un.has(a)?`'${a}'`:"bounded window operation"} requires a sortBy.`),m(!c.window||!ip.has(a),`${a} does not accept a 'window' field.`),s.push(c)}return e.forEach((i=>{let p=i.items,a=N(p),c={};for(let f of s){let{func:O,args:A,field:d,window:x}=f,g=E=>{let T=-1;return F=>{if(++T,O.left)return O.left(E(F,T),A,n);if(O.right)return O.right(F,E(F,T),{parentExpr:t,inputExpr:A,documentNumber:T+1,field:d},n)}};if(x){let{documents:E,range:T,unit:F}=x,D=E||T;if(!pp(x)){let[L,ut]=D,_=K=>L=="current"?K:L=="unbounded"?0:Math.max(L+K,0),W=K=>ut=="current"?K+1:ut=="unbounded"?p.length:ut+K+1,ct=(K,At)=>{if(E||D.every(h))return p.slice(_(At),W(At));let It=Object.keys(t.sortBy)[0],Ht,Jr;if(F){let gt=lr=>kt(K,{startDate:new Date(K[It]),unit:F,amount:lr},n).getTime();Ht=b(L)?gt(L):-1/0,Jr=b(ut)?gt(ut):1/0}else{let gt=K[It];Ht=b(L)?gt+L:-1/0,Jr=b(ut)?gt+ut:1/0}let He=L=="current"?At:0,to=ut=="current"?At+1:p.length,Ge=new Array;for(;He<to;){let gt=p[He++],lr=+gt[It];lr>=Ht&&lr<=Jr&&Ge.push(gt)}return Ge};c[d]=g(ct)}}c[d]||(c[d]=g(E=>p)),a=St(a,{[d]:{$function:{body:E=>c[d](E),args:["$$CURRENT"]}}},n)}o.push(a)})),dt(...o)}))};var ap={locf:"$locf",linear:"$linearFill"},mp=(r,t,n)=>{m(!t.sortBy||j(t.sortBy),"sortBy must be an object."),m(!!t.sortBy||Object.values(t.output).every(i=>M(i,"value")),"sortBy required if any output field specifies a 'method'."),m(!(t.partitionBy&&t.partitionByFields),"specify either partitionBy or partitionByFields."),m(!t.partitionByFields||t?.partitionByFields?.every(i=>i[0]!=="$"),"fields in partitionByFields cannot begin with '$'."),n=yt(n),n.context.addExpressionOps({$ifNull:le}),n.context.addWindowOps({$locf:Fe,$linearFill:Ue});let e=t.partitionBy||t?.partitionByFields?.map(i=>"$"+i),o={},s={};for(let[i,p]of Object.entries(t.output))if(M(p,"value"))o[i]={$ifNull:[`$$CURRENT.${i}`,p.value]};else{let a=ap[p.method];m(!!a,`invalid fill method '${p.method}'.`),s[i]={[a]:"$"+i}}return Object.keys(s).length>0&&(r=Ve(r,{sortBy:t.sortBy||{},partitionBy:e,output:s},n)),Object.keys(o).length>0&&(r=St(r,o,n)),r};function qr(r,t){let n=!!r&&r[0]?.$documents;return n?{documents:Re(null,n,t).value(),pipeline:r.slice(1)}:{pipeline:r}}var We=(r,t,n)=>{let e=h(t.from)?n?.collectionResolver(t.from):t.from,{let:o,foreignField:s,localField:i}=t,p=A=>[!0,[]],{documents:a,pipeline:c}=qr(t.pipeline??[],n);if(m(!e!=!a,"$lookup: must specify single join input with `expr.from` or `expr.pipeline`."),e=e??a,m(y(e),"$lookup: join collection must resolve to an array."),s&&i){let A=z.init(n.hashFunction);for(let d of e)et(k(d,s)??null).forEach(x=>{let g=A.get(x),E=g??[];E.push(d),E!==g&&A.set(x,E)});if(p=d=>{let x=k(d,i)??null;if(y(x)){if(c.length)return[x.some(T=>A.has(T)),null];let E=Array.from(new Set(nt(x.map(T=>A.get(T),n.hashFunction))));return[E.length>0,E]}let g=A.get(x)??null;return[g!==null,g??[]]},c.length===0)return r.map(d=>({...d,[t.as]:p(d).pop()}))}let f=new pt(c,n),O={...n};return r.map(A=>{let d=u(A,o,null,n);O.variables={...n.variables,...d};let[x,g]=p(A);return{...A,[t.as]:x?f.run(e,O):g}})};var up=(r,t,n)=>{let e=h(t.from)?n?.collectionResolver(t.from):t.from,{connectFromField:o,connectToField:s,as:i,maxDepth:p,depthField:a,restrictSearchWithMatch:c}=t,f=c?{pipeline:[{$match:c}]}:{};return r.map(O=>{let A={};jt(A,o,u(O,t.startWith,null,n));let d=[A],x=-1,g=z.init(n.hashFunction);do{x++,d=nt(We(N(d),{from:e,localField:o,foreignField:s,as:i,...f},n).map(D=>D[i]).value());let F=g.size;if(d.forEach(D=>g.set(D,g.get(D)??x)),F==g.size)break}while(l(p)||x<p);let E=new Array(g.size),T=0;return g.forEach((F,D)=>{E[T++]=Object.assign(a?{[a]:F}:{},D)}),{...O,[i]:E}})};var cr={};lt(cr,{$elemMatch:()=>cp,$slice:()=>lp});var cp=(r,t,n,e)=>{let o=k(r,n),s=new X(t,e);m(y(o),"$elemMatch: argument must resolve to array");let i=[];for(let p=0;p<o.length;p++)if(s.test(o[p])){if(e.useStrictMode)return[o[p]];i.push(o[p])}return i.length>0?i:void 0};var lp=(r,t,n,e)=>{let o=k(r,n),s=t;return y(o)?ce(r,y(t)?[o,...s]:[o,t],e):o};var Ct={};lt(Ct,{$all:()=>fp,$and:()=>Ep,$bitsAllClear:()=>Fn,$bitsAllSet:()=>Vn,$bitsAnyClear:()=>Wn,$bitsAnySet:()=>Bn,$elemMatch:()=>yp,$eq:()=>Ln,$exists:()=>Ap,$expr:()=>dp,$gt:()=>zn,$gte:()=>Qn,$in:()=>Kn,$jsonSchema:()=>xp,$lt:()=>qn,$lte:()=>Yn,$mod:()=>gp,$ne:()=>Hn,$nin:()=>Gn,$nor:()=>$p,$not:()=>Ip,$or:()=>Be,$regex:()=>hp,$size:()=>Op,$type:()=>bp,$where:()=>jp});var fp=(r,t,n)=>C(r,t,n,fn);var yp=(r,t,n)=>C(r,t,n,ue);var Op=(r,t,n)=>C(r,t,n,yn);var $t=(r,t,n)=>C(r,t,null,(e,o)=>{let s=0;if(y(o))for(let i of o)s=s|1<<i;else s=o;return n(e&s,s)});var Fn=(r,t,n)=>$t(r,t,(e,o)=>e==0);var Vn=(r,t,n)=>$t(r,t,(e,o)=>e==o);var Wn=(r,t,n)=>$t(r,t,(e,o)=>e<o);var Bn=(r,t,n)=>$t(r,t,(e,o)=>e>0);var Ln=(r,t,n)=>C(r,t,n,er);var zn=(r,t,n)=>C(r,t,n,Sr);var Qn=(r,t,n)=>C(r,t,n,Cr);var Kn=(r,t,n)=>C(r,t,n,me);var qn=(r,t,n)=>C(r,t,n,Nr);var Yn=(r,t,n)=>C(r,t,n,kr);var Hn=(r,t,n)=>C(r,t,n,Tr);var Gn=(r,t,n)=>C(r,t,n,wr);var Ap=(r,t,n)=>{let e=r.includes("."),o=!!t;return!e||r.match(/\.\d+$/)?s=>k(s,r)!==void 0===o:s=>{let i=bt(s,r,{preserveIndex:!0}),p=k(i,r.substring(0,r.lastIndexOf(".")));return y(p)?p.some(a=>a!==void 0)===o:p!==void 0===o}};var bp=(r,t,n)=>C(r,t,n,On);function dp(r,t,n){return e=>u(e,t,null,n)}function xp(r,t,n){m(!!n?.jsonSchemaValidator,"$jsonSchema: must configure 'jsonSchemaValidator' option to this operator.");let e=n?.jsonSchemaValidator(t);return o=>e(o)}var gp=(r,t,n)=>C(r,t,n,cn);var hp=(r,t,n)=>C(r,t,n,ln);function jp(r,t,n){m(n.scriptEnabled,"$where: 'scriptEnabled' option must be true");let e=t;return m(Xt(e),"$where only accepts a Function object"),o=>Q(e.call(o),n?.useStrictMode)}var Ep=(r,t,n)=>{m(y(t),"Invalid expression: $and expects value to be an Array.");let e=t.map(o=>new X(o,n));return o=>e.every(s=>s.test(o))};var Be=(r,t,n)=>{m(y(t),"Invalid expression. $or expects value to be an Array");let e=t.map(o=>new X(o,n));return o=>e.some(s=>s.test(o))};var $p=(r,t,n)=>{m(y(t),"Invalid expression. $nor expects value to be an array.");let e=Be("$or",t,n);return o=>!e(o)};var Ip=(r,t,n)=>{let e={};e[r]=Or(t);let o=new X(e,n);return s=>!o.test(s)};var Ot=class extends X{constructor(t,n){let e=yt(n);e.context.addExpressionOps(nr).addExpressionOps(or).addProjectionOps(cr).addQueryOps(Ct),super(t,e)}};var Tp=(r,t,n)=>{let e=new Ot(t,n);return r.filter(o=>e.test(o))};var wp=(r,t,n)=>{let e=h(t.into)?n?.collectionResolver(t.into):t.into;m(y(e),"$merge: option 'into' must resolve to an array");let o=t.on||n.idKey,s=h(o)?a=>Zt(k(a,o),n.hashFunction):a=>Zt(o.map(c=>k(a,c),n.hashFunction)),i=z.init();for(let a=0;a<e.length;a++){let c=e[a],f=s(c);m(!i.has(f),"$merge: 'into' collection must have unique entries for the 'on' field."),i.set(f,[c,a])}let p=I.init(n);return r.map(a=>{let c=s(a);if(i.has(c)){let[f,O]=i.get(c),A=u(f,t.let||{new:"$$ROOT"},null,p.update(a));if(y(t.whenMatched)){let d=new pt(t.whenMatched,{...n,variables:A});e[O]=d.run([f])[0]}else switch(t.whenMatched){case"replace":e[O]=a;break;case"fail":throw new Dt("$merge: failed due to matching as specified by 'whenMatched' option.");case"keepExisting":break;case"merge":default:e[O]=Ne(f,[f,a],p.update(a,{variables:A}));break}}else switch(t.whenNotMatched){case"discard":break;case"fail":throw new Dt("$merge: failed due to matching as specified by 'whenMatched' option.");case"insert":default:e.push(a);break}return a})};var Np=(r,t,n)=>{let e=h(t)?n?.collectionResolver(t):t;return m(y(e),"expression must resolve to an array"),r.map(o=>(e.push(G(o)),o))};var kp=(r,t,n)=>{let e=I.init(n);return r.map(o=>br(o,t,e.update(o)))};var Sp=(r,t,n)=>r.map(e=>(e=u(e,t.newRoot,null,n),m(j(e),"$replaceRoot expression must return an object"),e));var Cp=(r,t,n)=>r.map(e=>(e=u(e,t,null,n),m(j(e),"$replaceWith expression must return an object"),e));var vp=(r,t,n)=>r.transform(e=>{let o=e.length,s=-1;return()=>{if(++s===t.size)return{done:!0};let i=Math.floor(Math.random()*o);return{value:e[i],done:!1}}});var Dp=St;var _p=(r,t,n)=>Z(ur(r,{_id:t,count:{$sum:1}},n),{count:-1},n);var Mp=(r,t,n)=>{let{coll:e,pipeline:o}=h(t)||y(t)?{coll:t}:t,s=h(e)?n.collectionResolver(e):e,{documents:i,pipeline:p}=qr(o??[],n);m(!s!=!i,"$unionWith: must specify single collection input with `expr.coll` or `expr.pipeline`.");let a=s??i;return dt(r,p?new pt(p,n).stream(a):N(a))};var Pp=(r,t,n)=>{t=et(t);let e={};for(let o of t)e[o]=0;return rr(r,e,n)};var Rp=(r,t,n)=>{h(t)&&(t={path:t});let o=t.path.substring(1),s=t?.includeArrayIndex||!1,i=t.preserveNullAndEmptyArrays||!1,p=(c,f)=>(s!==!1&&(c[s]=f),c),a;return N(()=>{for(;;){if(a instanceof Ft){let O=a.next();if(!O.done)return O}let c=r.next();if(c.done)return c;let f=c.value;if(a=k(f,o),y(a)){if(a.length===0&&i===!0)return a=null,Tt(f,o),{value:p(f,null),done:!1};a=N(a).map(((O,A)=>{let d=bt(f,o,{preserveKeys:!0});return jt(d,o,O),p(d,A)}))}else if(!Y(a)||i===!0)return{value:p(f,null),done:!1}}})};var ze={};lt(ze,{$denseRank:()=>Up,$derivative:()=>Fp,$documentNumber:()=>Vp,$expMovingAvg:()=>Wp,$integral:()=>Bp,$linearFill:()=>Ue,$locf:()=>Fe,$minMaxScaler:()=>Lp,$rank:()=>zp,$shift:()=>Qp});var Up=(r,t,n,e)=>Qr(r,t,n,e,!0);var Fp=(r,t,n,e)=>{if(t.length<2)return null;let{input:o,unit:s}=n.inputExpr,i="$"+Object.keys(n.parentExpr.sortBy)[0],p=[t[0],t[t.length-1]],a=$(p,[i,o],e).filter((([x,g])=>b(+x)&&b(+g)));if(a.length!==2)return null;let[[c,f],[O,A]]=a,d=(O-c)/(mt[s]||1);return(A-f)/d};var Vp=(r,t,n,e)=>n.documentNumber;var Wp=(r,t,n,e)=>{let{input:o,N:s,alpha:i}=n.inputExpr;return m(!(s&&i),"You must specify either N or alpha. You cannot specify both."),xt(t,n,()=>{let p=$(t,o,e).filter(b);return p.length===t.length?p:null},p=>{if(p===null)return null;if(n.documentNumber==1)return p[0];let a=s!=null?2/(s+1):i,c=n.documentNumber-1;return p[c]=p[c]*a+p[c-1]*(1-a),p[c]})};var Bp=(r,t,n,e)=>{let{input:o,unit:s}=n.inputExpr,i="$"+Object.keys(n.parentExpr.sortBy)[0],p=$(t,[i,o],e).filter((([f,O])=>b(+f)&&b(+O)));if(p.length!==t.length)return null;let a=0,c=t.length;for(let f=1;f<c;f++){let[O,A]=p[f-1],[d,x]=p[f],g=(d-O)/(mt[s]||1);a+=.5*(A+x)*g}return a};var Lp=(r,t,n,e)=>xt(t,n,()=>{let o=n.inputExpr,s=o.min||0,i=o.max||1,p=$(t,o.input||n.inputExpr,e);m(y(p)&&p.length>0&&p.every(b),"$minMaxScaler: input must be a numeric array");let a=p[0],c=p[0];for(let A of p)A<a?a=A:A>c&&(c=A);let f=i-s,O=c-a;return m(O!==0,"$minMaxScaler: input range must not be zero"),{min:s,scale:f,rmin:a,range:O,nums:p}},o=>{let{min:s,rmin:i,scale:p,range:a,nums:c}=o;return(c[n.documentNumber-1]-i)/a*p+s});var zp=(r,t,n,e)=>Qr(r,t,n,e,!1);var Qp=(r,t,n,e)=>{let o=n.inputExpr,s=n.documentNumber-1+o.by;return s<0||s>t.length-1?o.default?u(r,o.default,null,e):null:u(t[s],o.output,null,e)};var Jn=()=>tt.init().addAccumulatorOps(ie).addExpressionOps(Pe).addPipelineOps(Le).addProjectionOps(cr).addQueryOps(Ct).addWindowOps(ze);var Yr={};lt(Yr,{$addToSet:()=>qp,$bit:()=>Hp,$currentDate:()=>Gp,$inc:()=>Jp,$max:()=>Xp,$min:()=>Zp,$mul:()=>ta,$pop:()=>ra,$pull:()=>Qe,$pullAll:()=>ea,$push:()=>oa,$rename:()=>sa,$set:()=>Ke,$unset:()=>ia});var v={cloneMode:"copy",queryOptions:yt({context:tt.init().addQueryOps(Ct).addExpressionOps(nr).addExpressionOps(or)})},Yt=(r,t)=>{switch(r){case"deep":return G(t);case"copy":return S(t)?new Date(t):y(t)?[...t]:j(t)?{...t}:H(t)?new RegExp(t):t;default:return t}},Kp=/^[a-z]+[a-zA-Z0-9]*$/;function Xn(r){if(!r.includes(".$"))return[{parent:r,selector:r},[]];let t=r.indexOf(".$"),n=r.indexOf("]"),e=r.substring(0,t),o=r.substring(t+3,n);m(o===""||Kp.test(o),"The filter <identifier> must begin with a lowercase letter and contain only alphanumeric characters.");let s=r.substring(n+2),[i,p]=s?Xn(s):[];return[{selector:r,parent:e,child:o||"$",next:i},[o,...p||[]].filter(Boolean)]}var U=(r,t,n,e,o)=>{let{parent:s,child:i,next:p}=t;if(!i){let c=!1;return _t(r,s,(O,A)=>c=!!e(O,A)||c,o),c}let a=k(r,s);return y(a)?a.map((c,f)=>n[i]&&!n[i].test({[i]:c})?!1:p?U(c,p,n,e,o):e(a,f)).some(Boolean):!1};function V(r,t,n,e){let o=[];for(let[s,i]of Object.entries(r)){let[p,a]=Xn(s);if(!a.length)e(i,p,{})&&o.push(p.parent);else{let c={};t.forEach(O=>{Object.keys(O).forEach(A=>{a.forEach(d=>{(A===d||A.startsWith(d+"."))&&(c[d]=c[d]||{},Object.assign(c[d],{[A]:O[A]}))})})});let f={};for(let[O,A]of Object.entries(c))f[O]=new Ot(A,n.queryOptions);e(i,p,f)&&o.push(p.parent)}}return o}var qp=(r,t,n=[],e=v)=>V(t,n,e,(o,s,i)=>{let p={$each:[o]};return j(o)&&M(o,"$each")&&Object.assign(p,o),U(r,s,i,(a,c)=>{let f=a[c]||=[];return Mt([f,p.$each]).length===p.$each.length?!1:(a[c]=Yt(e.cloneMode,Pt(f.concat(p.$each))),!0)},{buildGraph:!0})});var Yp=new Set(["and","or","xor"]),Hp=(r,t,n=[],e=v)=>V(t,n,e,((o,s,i)=>{let p=Object.keys(o);return m(p.length===1&&Yp.has(p[0]),`Invalid bit operator '${p[0]}'. Must be one of 'and', 'or', or 'xor'.`),U(r,s,i,(a,c)=>{let f=a[c],O=o[p[0]];if(f!==void 0&&!(b(f)&&b(O)))return!1;switch(f=f||0,p[0]){case"and":a[c]=f&O;break;case"or":a[c]=f|O;break;case"xor":a[c]=f^O;break}return a[c]!==f},{buildGraph:!0})}));var Gp=(r,t,n=[],e=v)=>{let o=Date.now();return V(t,n,e,((s,i,p)=>U(r,i,p,(a,c)=>(a[c]=o,!0),{buildGraph:!0})))};var Jp=(r,t,n=[],e=v)=>V(t,n,e,(o,s,i)=>{if(!s.child){let p=k(r,s.parent);m(p===void 0||b(p),"cannot apply $inc to a value of non-numeric type")}return U(r,s,i,(p,a)=>(p[a]=(p[a]||=0)+o,!0),{buildGraph:!0})});var Xp=(r,t,n=[],e=v)=>V(t,n,e,((o,s,i)=>U(r,s,i,(p,a)=>p[a]!==void 0&&w(p[a],o)>-1?!1:(p[a]=o,!0),{buildGraph:!0})));var Zp=(r,t,n=[],e=v)=>V(t,n,e,((o,s,i)=>U(r,s,i,(p,a)=>p[a]!==void 0&&w(p[a],o)<1?!1:(p[a]=o,!0),{buildGraph:!0})));var ta=(r,t,n=[],e=v)=>V(t,n,e,((o,s,i)=>U(r,s,i,(p,a)=>{let c=p[a];return p[a]=p[a]===void 0?0:p[a]*o,p[a]!==c},{buildGraph:!0})));var ra=(r,t,n=[],e=v)=>V(t,n,e,((o,s,i)=>U(r,s,i,(p,a)=>{let c=p[a];return m(y(c),`path '${s.selector}' contains an element of non-array type.`),c.length?(o===-1?c.splice(0,1):c.pop(),!0):!1})));var Qe=(r,t,n=[],e=v)=>V(t,n,e,((o,s,i)=>{let p=!j(o)||Object.keys(o).some(J),a=new Ot(p?{k:o}:o,e.queryOptions),c=p?f=>a.test({k:f}):f=>a.test(f);return U(r,s,i,(f,O)=>{let A=f[O],d=new Array;return A.map(g=>{let E=c(g);return E||d.push(g),E}).some(Boolean)?(f[O]=d,!0):!1})}));var ea=(r,t,n=[],e=v)=>{let o={};return Object.entries(t).forEach(([s,i])=>{o[s]={$in:i}}),Qe(r,o,n,e)};var na=["$each","$slice","$sort","$position"],oa=(r,t,n=[],e=v)=>V(t,n,e,((o,s,i)=>{let p={$each:[o]};return j(o)&&na.some(a=>M(o,a))&&Object.assign(p,o),U(r,s,i,(a,c)=>{let f=a[c]||=[],O=f.slice(0,p.$slice||f.length),A=f.length,d=b(p.$position)?p.$position:f.length;if(f.splice(d,0,...Yt(e.cloneMode,p.$each)),p.$sort){let x=j(p.$sort)?Object.keys(p.$sort||{}).pop():"",g=x?p.$sort[x]:p.$sort,E=x?T=>k(T,x):T=>T;f.sort((T,F)=>g*w(E(T),E(F)))}return b(p.$slice)&&(p.$slice<0?f.splice(0,f.length+p.$slice):f.splice(p.$slice)),A!=f.length||!B(O,f)},{descendArray:!0,buildGraph:!0})}));var Ke=(r,t,n=[],e=v)=>V(t,n,e,(o,s,i)=>U(r,s,i,(p,a)=>B(p[a],o)?!1:(p[a]=Yt(e.cloneMode,o),!0),{buildGraph:!0}));var sa=(r,t,n=[],e=v)=>{let o=[],s=V(t,n,e,((i,p,a)=>U(r,p,a,(c,f)=>M(c,f)?(o.push(...Ke(r,{[i]:c[f]},n,e)),delete c[f],!0):!1)));return Array.from(new Set(s.concat(o)))};var ia=(r,t,n=[],e=v)=>V(t,n,e,(o,s,i)=>U(r,s,i,(p,a)=>M(p,a)?(y(p)?p[a]=null:delete p[a],!0):!1));function qe(r){return r=r??v,(t,n,e=[],o={},s=r)=>{let i=Object.entries(n);m(i.length===1,"Update expression must contain only one operator.");let[p,a]=i[0];m(M(Yr,p),`Update operator '${p}' is not supported.`);let c=Yr[p];return Object.keys(o).length&&!new Ot(o,s.queryOptions).test(t)?[]:c(t,a,e,s)}}var iS=qe();var pa=Jn(),Ye=r=>{let t=yt(r);return{...t,context:tt.merge(pa,t.context)}},Hr=class extends X{constructor(t,n){super(t,Ye(n))}},Gr=class extends pt{constructor(t,n){super(t,Ye(n))}},Zn=r=>qe({...r,queryOptions:Ye(r?.queryOptions)}),aa=Zn(),ma=(r,t,n)=>new Gr(t,n).run(r),ua=(r,t,n,e)=>new Hr(t,e).find(r,n);return so(ca);})();
